#!/bin/sh

# Run secrets scan first (fast, catches sensitive data before commit)
./scripts/secrets-scan.sh || exit 1

# Technical debt check (fast, catches new debt before commit)
if command -v npx >/dev/null 2>&1; then
  npx tsx scripts/debt-check.ts 2>/dev/null || {
    echo "‚ö†Ô∏è  Technical debt thresholds exceeded. Run: npm run debt:check"
    exit 1
  }
fi

# Check if any message files are staged
if git diff --cached --name-only | grep -q "^messages/"; then
  # i18n validation: Ensure translation files are consistent
  npm run i18n:check || exit 1
fi

# Run lint-staged (formatting, linting)
npx lint-staged

# Run CSP validation if CSP-related files are staged
# This catches CSP issues before they break production (saves Vercel build costs)
if git diff --cached --name-only | grep -qE "(proxy\.ts|providers\.tsx|csp)" ; then
  echo "üìã CSP-related files changed - running CSP validation..."
  npm run test:unit -- csp-validation --reporter=dot 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "‚ùå CSP validation failed! Fix issues before committing."
    echo "   Run: npm run test:unit -- csp-validation"
    exit 1
  fi
  echo "‚úÖ CSP validation passed"
fi

# Check for mobile regression patterns (F-09)
# Pattern: w-full followed by sm:w-*, md:w-*, or lg:w-* WITHOUT max-w-* constraint
# EXCLUDES: w-auto patterns (valid for buttons) and w-64/similar (valid for sidebars)
# Only checks ADDED/MODIFIED lines, not pre-existing code
echo "üì± Checking for mobile regression patterns..."
MOBILE_ISSUES=$(git diff --cached -U0 -- "*.tsx" "*.ts" 2>/dev/null | grep "^+" | grep -v "^+++" | grep "w-full sm:w-\|w-full md:w-\|w-full lg:w-" | grep -v "max-w-" | grep -v "w-auto" || true)

if [ -n "$MOBILE_ISSUES" ]; then
  echo "‚ùå Mobile regression pattern detected in NEW code!"
  echo ""
  echo "Found 'w-full sm:w-*' or similar without 'max-w-*' constraint:"
  echo "$MOBILE_ISSUES"
  echo ""
  echo "‚ö†Ô∏è  This pattern breaks mobile layouts (F-09 requirement)."
  echo ""
  echo "‚úÖ FIX: Use one of these patterns instead:"
  echo "  ‚Ä¢ w-28 sm:w-72                    (fixed width on mobile)"
  echo "  ‚Ä¢ w-full max-w-xs sm:w-72        (constrained full width)"
  echo "  ‚Ä¢ w-[min(7rem,85vw)] sm:w-72     (CSS min function)"
  echo "  ‚Ä¢ w-full sm:w-auto               (valid for buttons)"
  echo ""
  exit 1
fi
echo "‚úÖ No mobile regression patterns found"
