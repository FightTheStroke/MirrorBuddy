#!/bin/sh

# Run secrets scan first (fast, catches sensitive data before commit)
./scripts/secrets-scan.sh || exit 1

# Run lint-staged (formatting, linting)
npx lint-staged

# Run CSP validation if CSP-related files are staged
# This catches CSP issues before they break production (saves Vercel build costs)
if git diff --cached --name-only | grep -qE "(proxy\.ts|providers\.tsx|csp)" ; then
  echo "üìã CSP-related files changed - running CSP validation..."
  npm run test:unit -- csp-validation --reporter=dot 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "‚ùå CSP validation failed! Fix issues before committing."
    echo "   Run: npm run test:unit -- csp-validation"
    exit 1
  fi
  echo "‚úÖ CSP validation passed"
fi

# Check for mobile regression patterns (F-09)
# Pattern: w-full followed by sm:w-*, md:w-*, or lg:w-* WITHOUT max-w-* constraint
# This catches patterns like "w-full sm:w-72" which break mobile layouts
echo "üì± Checking for mobile regression patterns..."
MOBILE_ISSUES=$(git diff --cached --name-only | xargs grep -n "w-full sm:w-\|w-full md:w-\|w-full lg:w-" --include="*.tsx" --include="*.ts" 2>/dev/null | grep -v "max-w-" | grep -v "node_modules" || true)

if [ -n "$MOBILE_ISSUES" ]; then
  echo "‚ùå Mobile regression pattern detected!"
  echo ""
  echo "Found 'w-full sm:w-*' or similar without 'max-w-*' constraint:"
  echo "$MOBILE_ISSUES"
  echo ""
  echo "‚ö†Ô∏è  This pattern breaks mobile layouts (F-09 requirement)."
  echo ""
  echo "‚úÖ FIX: Use one of these patterns instead:"
  echo "  ‚Ä¢ w-28 sm:w-72                    (fixed width on mobile)"
  echo "  ‚Ä¢ w-full max-w-xs sm:w-72        (constrained full width)"
  echo "  ‚Ä¢ w-[min(7rem,85vw)] sm:w-72     (CSS min function)"
  echo ""
  exit 1
fi
echo "‚úÖ No mobile regression patterns found"
