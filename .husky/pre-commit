#!/bin/sh

# Run secrets scan first (fast, catches sensitive data before commit)
./scripts/secrets-scan.sh || exit 1

# Check if any message files are staged
if git diff --cached --name-only | grep -q "^messages/"; then
  # i18n validation: Ensure translation files are consistent
  npm run i18n:check || exit 1
fi

# Run lint-staged (formatting, linting)
npx lint-staged

# Run CSP validation if CSP-related files are staged
# This catches CSP issues before they break production (saves Vercel build costs)
if git diff --cached --name-only | grep -qE "(proxy\.ts|providers\.tsx|csp)" ; then
  echo "üìã CSP-related files changed - running CSP validation..."
  npm run test:unit -- csp-validation --reporter=dot 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "‚ùå CSP validation failed! Fix issues before committing."
    echo "   Run: npm run test:unit -- csp-validation"
    exit 1
  fi
  echo "‚úÖ CSP validation passed"
fi

# Mobile regression pattern check (F-09)
# Detects w-full sm:w-* patterns without max-w constraint
if git diff --cached --name-only | grep -qE "\.tsx$" ; then
  MOBILE_ISSUES=$(git diff --cached --name-only -- "*.tsx" | xargs grep -l "w-full sm:w-\|w-full md:w-\|w-full lg:w-" 2>/dev/null | xargs grep -L "max-w-" 2>/dev/null || true)
  if [ -n "$MOBILE_ISSUES" ]; then
    echo "‚ùå Mobile regression pattern detected!"
    echo ""
    echo "Files with 'w-full sm:w-*' without 'max-w-*' constraint:"
    echo "$MOBILE_ISSUES"
    echo ""
    echo "FIX: Use one of these patterns instead:"
    echo "  ‚Ä¢ w-28 sm:w-72              (fixed width on mobile)"
    echo "  ‚Ä¢ w-full max-w-xs sm:w-72   (constrained full width)"
    echo "  ‚Ä¢ w-[min(7rem,85vw)] sm:w-72 (CSS min function)"
    echo ""
    exit 1
  fi
fi
