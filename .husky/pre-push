#!/usr/bin/env bash
set -euo pipefail

# === CRITICAL GATES: Unit Tests + Debt + Vercel Sim ===
# Typecheck is intentionally omitted here â€” pre-push-vercel.sh runs a full
# production build which includes type checking. Avoids redundant double-check.

# i18n validation (unconditional - ensures translation consistency)
npm run i18n:check || exit 1

# Check for duplicate commit messages in last 5 commits
DUPLICATE_COMMITS=$(git log --oneline -5 | awk '{$1=""; print $0}' | sort | uniq -d)
if [ -n "$DUPLICATE_COMMITS" ]; then
  echo "ERROR: Duplicate commit messages found in last 5 commits:"
  echo "$DUPLICATE_COMMITS"
  echo ""
  echo "Each commit should have a unique message. Use git rebase -i to edit."
  exit 1
fi

# Audit environment variables (ensures all process.env.X are documented)
./scripts/env-var-audit.sh || exit 1

echo "Running unit tests..."
npm run test:unit -- --reporter=dot 2>&1 | tail -5
# $? after pipe captures tail's exit code; use PIPESTATUS for the test runner
if [ "${PIPESTATUS[0]}" -ne 0 ]; then
  echo "Unit tests failed. Fix failing tests before pushing."
  echo "  Run: npm run test:unit"
  exit 1
fi

# Technical debt check (PR-level gate, not per-commit)
if command -v npx >/dev/null 2>&1; then
  npx tsx scripts/debt-check.ts 2>/dev/null || {
    echo "Technical debt thresholds exceeded. Run: npm run debt:check"
    exit 1
  }
fi

./scripts/pre-push-vercel.sh
