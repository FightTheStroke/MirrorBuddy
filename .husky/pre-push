#!/usr/bin/env bash
set -euo pipefail

# === CRITICAL GATES: Unit Tests + Debt + Vercel Sim ===
# Typecheck is intentionally omitted here â€” pre-push-vercel.sh runs a full
# production build which includes type checking. Avoids redundant double-check.

echo "Running unit tests..."
npm run test:unit -- --reporter=dot 2>&1 | tail -5
# $? after pipe captures tail's exit code; use PIPESTATUS for the test runner
if [ "${PIPESTATUS[0]}" -ne 0 ]; then
  echo "Unit tests failed. Fix failing tests before pushing."
  echo "  Run: npm run test:unit"
  exit 1
fi

# Technical debt check (PR-level gate, not per-commit)
if command -v npx >/dev/null 2>&1; then
  npx tsx scripts/debt-check.ts 2>/dev/null || {
    echo "Technical debt thresholds exceeded. Run: npm run debt:check"
    exit 1
  }
fi

./scripts/pre-push-vercel.sh
