# === CRITICAL GATES: Typecheck + Unit Tests ===
# These MUST pass before pushing. Catches broken imports, type errors, and test failures
# that would otherwise only be caught on CI (wasting time and blocking deploys).

echo "Running typecheck..."
npm run typecheck || {
  echo "Typecheck failed. Fix type errors before pushing."
  echo "  Run: npm run typecheck"
  exit 1
}

echo "Running unit tests..."
npm run test:unit -- --reporter=dot 2>&1 | tail -5
if [ ${PIPESTATUS[0]} -ne 0 ]; then
  echo "Unit tests failed. Fix failing tests before pushing."
  echo "  Run: npm run test:unit"
  exit 1
fi

# Technical debt check (PR-level gate, not per-commit)
if command -v npx >/dev/null 2>&1; then
  npx tsx scripts/debt-check.ts 2>/dev/null || {
    echo "Technical debt thresholds exceeded. Run: npm run debt:check"
    exit 1
  }
fi

./scripts/pre-push-vercel.sh
