# ConvergioEdu Architecture Review & Action Plan
## January 1, 2026

**Reviewer**: Claude Code (Senior Software Architect)
**Methodology**: ISE Engineering Fundamentals + BRUTALE ONESTA

---

## EXECUTIVE SUMMARY (TL;DR)

1. **2 FAILING UNIT TESTS** - mastery.test.ts tests localStorage but code uses API
2. **MASSIVE COMPONENT** - settings-view.tsx at 3649 lines needs immediate splitting
3. **14 ESLint warnings** - including 2 missing alt props (a11y violations)
4. **UNTRACKED FILE** - use-saved-materials.ts not committed
5. **localStorage remnants** - 5 legitimate uses, test needs update

---

## 1. FRONTEND / CLIENT ARCHITECTURE

### Critical Issues

- [ ] **settings-view.tsx: 3649 lines** - SPLIT IMMEDIATELY
  - Extract: AccountSection, AIProviderSection, AccessibilitySection, VoiceSection, DangerZone
  - Target: max 500 lines per component
  - Location: `src/components/settings/settings-view.tsx`

- [ ] **conversation-flow.tsx: 1281 lines** - Needs refactoring
  - Extract: CharacterSelector, MessageList, InputArea as separate components
  - Location: `src/components/conversation/conversation-flow.tsx`

- [ ] **archive-view.tsx: 1096 lines** - Needs refactoring
  - Extract: FilterBar, MaterialCard, DeleteDialog as separate components
  - Location: `src/components/education/archive-view.tsx`

### Accessibility Violations

- [ ] **Missing alt props** - `src/components/education/mindmaps-view.tsx:504,508`
  - Lines 504 and 508 have `<img>` without alt attributes
  - WCAG 2.1 AA violation - fix immediately

- [ ] **No-img-element warning** - `src/components/collab/collaborator-avatars.tsx:133`
  - Using `<img>` instead of `<Image />` - performance impact

### Good Patterns

- [x] Code splitting with lazy loading (LazyQuizView, LazyFlashcardsView, etc.)
- [x] Proper React Compiler compliance
- [x] Consistent use of Tailwind + cn() utility
- [x] Accessibility provider architecture

---

## 2. BACKEND / API / ORCHESTRATION

### API Route Inventory

- **54 API routes** across 13 domains
- All using proper async handlers
- RESTful patterns followed

### Issues

- [ ] **No rate limiting** on public endpoints
  - Location: `src/app/api/*/route.ts`
  - Add rate limiting middleware for `/api/chat`, `/api/realtime/token`

- [ ] **Inconsistent error response format** - verify all routes use:
  ```typescript
  { error: { code: string, message: string } }
  ```

### Good Patterns

- [x] CORS-safe token endpoint for voice
- [x] Proper database transactions with Prisma
- [x] Safety filtering on chat routes

---

## 3. AI / ML / EXTERNAL SERVICES

### Current Architecture

- **Dual provider pattern**: Azure OpenAI (primary) + Ollama (fallback)
- **Voice**: Azure Realtime API with WebSocket proxy
- **Safety**: Guardrails injected into all prompts

### Issues

- [ ] **No fallback for voice** when Azure unavailable
  - Consider: graceful degradation to text-only mode with notification

- [ ] **Token budget tracking** not enforced
  - `Settings.budgetLimit` exists but not checked before API calls

### Good Patterns

- [x] Preview vs GA API handling in realtime-proxy.ts
- [x] Safety guardrails in all character prompts
- [x] HTTPS requirement documented for microphone

---

## 4. DATA LAYER & PERSISTENCE

### Database Schema

- **Prisma with libSQL adapter** (SQLite local, PostgreSQL prod)
- **30 models** with proper relations and indices
- **GDPR compliance**: StudentInsightProfile with consent tracking

### CRITICAL: localStorage Violations Check

Per CLAUDE.md ADR-0015 (Database First Architecture):

**Legitimate localStorage uses (OK)**:
1. `src/components/pwa/ios-install-banner.tsx` - Banner dismissal (device-specific)
2. `src/lib/hooks/use-permissions.ts` - Permission cache (device-specific)
3. `src/components/settings/settings-view.tsx:1502-1506` - Cleanup during data deletion
4. Test files checking localStorage as security pattern

**VIOLATION FOUND**:
- [ ] `src/lib/education/mastery.test.ts` - Tests expect localStorage but code uses API
  - This is causing 2 unit test failures
  - Fix: Update tests to mock fetch instead of localStorage

### Migration Status

- [x] Accessibility settings → API `/api/user/settings`
- [x] Progress/XP → API `/api/progress`
- [x] Materials → API `/api/materials`
- [x] Conversations → API `/api/conversations`
- [x] Mastery → API `/api/progress` (tests need update)

---

## 5. PERFORMANCE & SCALABILITY

### Identified Bottlenecks

- [ ] **No connection pooling** for database
- [ ] **No caching layer** for frequently accessed data (maestri list, settings)
- [ ] **Large component bundles** from 3649-line settings-view.tsx

### Optimization NOT Needed

- [x] SSE for tool streaming is appropriately lightweight
- [x] Code splitting already implemented for major views
- [x] React Compiler optimizations enabled

---

## 6. RELIABILITY & FALLBACKS

### Current Fallbacks

- [x] Azure → Ollama for text chat
- [x] Web Speech API fallback for onboarding TTS
- [ ] **MISSING**: Voice call fallback when Azure unavailable

### Issues

- [ ] **Silent failures** in some API routes - need consistent error propagation
- [ ] **No retry logic** for transient failures

---

## 7. SECURITY & COMPLIANCE

### Good Patterns

- [x] Safety guardrails on all AI interactions
- [x] GDPR consent tracking for parent dashboard
- [x] Age-gating for content
- [x] Jailbreak detection in safety module
- [x] No secrets in codebase

### Issues

- [ ] **Rate limiting missing** on public endpoints
- [ ] **CORS configuration** should be reviewed for production

### @ts-ignore/expect-error Audit

Only 2 legitimate uses found:
1. `src/lib/storage/__tests__/storage.test.ts:81` - Testing unknown type fallback
2. `src/components/tools/code-runner.tsx:38` - Pyodide global type

---

## 8. TESTING STRATEGY

### Current Coverage

- **Unit tests**: 24 test files, 890 passing, **2 FAILING**
- **E2E tests**: 27 Playwright spec files

### CRITICAL: Failing Tests

```
FAIL src/lib/education/mastery.test.ts
  - "should auto-save to localStorage" (line 130)
  - "should save and load state correctly" (line 416)
```

**Root Cause**: Tests mock localStorage but `mastery.ts` was refactored to use `/api/progress`

### Action Required

- [ ] **FIX mastery.test.ts** - Update tests to mock fetch instead of localStorage
- [ ] **Add missing tests** for:
  - `use-saved-materials.ts` hook
  - Voice session error handling
  - Parent-professor chat flow

### Test Gaps

- [ ] No unit tests for components (only lib modules have tests)
- [ ] API routes tested only via E2E
- [ ] Missing integration tests for database operations

---

## 9. CI/CD & DEPLOYMENT

### Current Pipeline

`.github/workflows/ci.yml`:
1. Build & Lint
2. Security Audit
3. Documentation Check
4. Code Quality

### Issues

- [ ] **Unit tests not in CI** - mastery failures would not block PR
  - Add `npm run test:unit` to CI pipeline

- [ ] **No E2E in CI** - acceptable (requires AI providers)

---

## 10. OBSERVABILITY & OPERATIONS

### Current Setup

- Server logger: `src/lib/logger.ts` - Production silent, dev verbose
- Client logger: `src/lib/client-error-logger.ts` - Captures to `/api/debug/log`
- Telemetry: TelemetryEvent model for Grafana integration

### Issues

- [ ] **No health check endpoint** - Add `/api/health`
- [ ] **No metrics endpoint** for monitoring (beyond `/api/metrics`)

### Good Patterns

- [x] Client error logger intercepts unhandled errors
- [x] Fetch error interception for debugging
- [x] Telemetry events with proper categorization

---

## 11. ARCHITECTURAL RISKS & IMPROVEMENTS

### High Priority Risks

1. **Monolithic settings component** - 3649 lines is unmaintainable
2. **Test-code divergence** - Mastery tests don't match implementation
3. **Untracked file** - use-saved-materials.ts not in version control

### Medium Priority

4. **No voice fallback** - Azure unavailable = no voice at all
5. **Rate limiting missing** - Potential for abuse
6. **Missing health checks** - No way to verify service status

### Low Priority

7. **localStorage in tests** - Cosmetic issue, tests need update
8. **Large components** - conversation-flow, archive-view need splitting
9. **Console.log statements** - 45 occurrences in 9 files (acceptable for dev)

---

## 12. ESLINT WARNINGS (14 total)

### Must Fix

| File | Line | Issue | Priority |
|------|------|-------|----------|
| `mindmaps-view.tsx` | 504 | Missing alt prop | HIGH (a11y) |
| `mindmaps-view.tsx` | 508 | Missing alt prop | HIGH (a11y) |
| `collaborator-avatars.tsx` | 133 | Use next/image | MEDIUM |

### Cleanup (Unused Variables in Tests)

| File | Issue |
|------|-------|
| `intent-detection.test.ts:21,22` | Unused IntentType, ToolType imports |
| `mastery.test.ts:33` | Unused saveMasteryState |
| `content-filter.test.ts:22-24` | Unused FilterResult, FilterSeverity, FilterAction |
| `mindmap-export.test.ts:6,10` | Unused beforeEach, MindmapNode |
| `mindmap-handler.test.ts:26` | Unused registerToolHandler |
| `quiz-handler.test.ts:23` | Unused registerToolHandler |
| `coverage/block-navigation.js:1` | Unused eslint-disable directive |

---

## 13. eslint-disable AUDIT

### Legitimate (Keep)

| File | Reason |
|------|--------|
| `homework-help.tsx:293,633` | User-uploaded data URLs |
| `archive-view.tsx:263,493` | User-captured data URLs |
| `pdf-preview.tsx:269,321` | PDF rendering data URLs |
| `subject-confirmation-dialog.tsx:114` | Dynamic image source |
| `waveform.tsx:176` | Visual randomness for animation |
| `formula-renderer.tsx:29` | KaTeX async rendering |
| `code-runner.tsx:141` | Pyodide async loading |

### Technical Debt (Consider Refactoring)

| File | Issue | Recommendation |
|------|-------|----------------|
| `use-saved-materials.ts` (4 instances) | Set state in effect | Use SWR or React Query |
| `flashcards-view.tsx:154` | Set state in effect | Use SWR or React Query |
| `settings-view.tsx:1106` | Set state in effect | Extract to custom hook |

---

## ACTION PLAN - EXECUTION ORDER

### Phase 1: Critical Fixes (Do First)

1. [ ] Fix 2 failing unit tests in `mastery.test.ts`
2. [ ] Add alt props to `mindmaps-view.tsx:504,508`
3. [ ] Stage and commit `use-saved-materials.ts`
4. [ ] Remove unused imports in test files

### Phase 2: Component Refactoring

5. [ ] Split `settings-view.tsx` into 5+ smaller components
6. [ ] Extract components from `conversation-flow.tsx`
7. [ ] Extract components from `archive-view.tsx`

### Phase 3: Testing & CI

8. [ ] Add `npm run test:unit` to CI pipeline
9. [ ] Add tests for `use-saved-materials.ts`
10. [ ] Add health check endpoint `/api/health`

### Phase 4: Production Hardening

11. [ ] Add rate limiting to public API endpoints
12. [ ] Add voice call fallback for Azure unavailability
13. [ ] Review and document CORS configuration

---

## ORPHAN PAGES ANALYSIS

**Result: NO ORPHAN PAGES FOUND**

All pages in `src/app/` are accessible:
- `/` - Home (requires onboarding)
- `/welcome` - Onboarding flow
- `/archivio` - Archive view
- `/conversazioni` - Conversations
- `/materiali` - Materials
- `/genitori` - Parent portal
- `/parent-dashboard` - Parent dashboard
- `/test-voice` - Dev testing
- `/landing` - Marketing
- `/showcase/*` - Feature demos

Navigation from home covers all main views via sidebar.

---

## UNTRACKED FILES

```
?? src/lib/hooks/use-saved-materials.ts
```

**Action**: Commit this file - it's a complete implementation for Issue #64

---

## VERIFICATION COMMANDS

```bash
# Run full verification
npm run lint          # Should show 14 warnings (0 errors)
npm run typecheck     # Should pass
npm run test:unit     # Currently 2 failures - need fix
npm run build         # Should pass
```

---

**Report Generated**: January 1, 2026
**Next Review**: After Phase 1 completion
