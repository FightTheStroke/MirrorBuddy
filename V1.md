# MirrorBuddy V1 — Consolidated Remediation Plan

**Date**: 14 February 2026
**Sources**: DUPLICATION-ANALYSIS.md, mirrorbuddy-voice-architecture-audit-2026-02-14.md, Voice26.md
**Purpose**: Single source of truth for all identified issues, prioritized and actionable

---

## TABLE OF CONTENTS

1. [Issue Registry](#issue-registry)
2. [Stream 1 — Voice: Safety + Personality](#stream-1)
3. [Stream 2 — Voice: GA Protocol Migration](#stream-2)
4. [Stream 3 — Voice: UX (Greetings + Phone Ring)](#stream-3)
5. [Stream 4 — i18n Cleanup](#stream-4)
6. [Stream 5 — State Management Consolidation](#stream-5)
7. [Stream 6 — UI Deduplication](#stream-6)
8. [Stream 7 — Services & Utility Consolidation](#stream-7)
9. [Stream 8 — API Standardization](#stream-8)
10. [Stream 9 — Dead Code Removal](#stream-9)
11. [Execution Waves](#execution-waves)
12. [Acceptance Criteria](#acceptance-criteria)
13. [Risk Matrix](#risk-matrix)
14. [ADR Updates Needed](#adr-updates)
15. [Statistics](#statistics)
16. [Appendices A-P — Technical Reference](#appendices)

---

<a id="issue-registry"></a>

## 1. ISSUE REGISTRY

45 issues from the three audits, deduplicated and cross-referenced.

### CRITICAL (P0) — Must fix immediately

| ID   | Issue                                                            | Source         | Stream |
| ---- | ---------------------------------------------------------------- | -------------- | ------ |
| V-01 | No safety guardrails in voice sessions                           | Voice26 P1     | S1     |
| V-02 | Voice systemPrompt truncated to 2000 chars (personality lost)    | Voice26 P2     | S1     |
| V-03 | Preview API deprecated 30 Apr 2026 (endpoint migration required) | VoiceArch §1   | S2     |
| V-04 | Session config not in token request (GA requires it)             | VoiceArch §1.3 | S2     |
| V-05 | Event names changed in GA protocol                               | VoiceArch §1.4 | S2     |
| D-01 | Two conversation stores with overlapping state                   | Dup F1         | S5     |
| D-02 | Four consent systems (GDPR risk)                                 | Dup F2         | S5     |

### HIGH (P1) — Fix in short term

| ID   | Issue                                                                               | Source         | Stream |
| ---- | ----------------------------------------------------------------------------------- | -------------- | ------ |
| V-06 | Greetings always Italian (5 locales supported but unused)                           | Voice26 P3     | S3     |
| V-07 | Formal professors use informal greetings                                            | Voice26 P4     | S3     |
| V-08 | ICE servers unnecessary (adds 300-500ms latency)                                    | VoiceArch §2.1 | S2     |
| V-09 | ICE gathering wait unnecessary (adds 200-500ms)                                     | VoiceArch §2.2 | S2     |
| V-10 | Double fetch in SDP exchange (adds 100-300ms)                                       | VoiceArch §2.3 | S2     |
| V-11 | Sequential fetches in session config (adds 200-400ms)                               | VoiceArch §2.4 | S2     |
| D-03 | Three separate chat components (MaestroSession, CharacterChatView, MatConversation) | Dup A1         | S6     |
| D-04 | Three message bubble variants (TTS only in maestro)                                 | Dup A2         | S6     |
| D-05 | Handoff absent from MaestroSession                                                  | Dup A5         | S6     |
| D-06 | `voice` namespace not in NAMESPACES array (8 components broken)                     | Dup C3         | S4     |
| D-07 | `analytics` namespace not loaded (2 components broken)                              | Dup C3         | S4     |
| D-08 | Four `calculateLevel()` with different algorithms                                   | Dup D1         | S7     |
| D-09 | Two i18n config files (root is dead code but confusing)                             | Dup C1         | S4     |
| D-10 | Two i18n message systems (namespace files vs aggregated JSON)                       | Dup C2         | S4     |

### MEDIUM (P2) — Fix in medium term

| ID   | Issue                                                                     | Source         | Stream |
| ---- | ------------------------------------------------------------------------- | -------------- | ------ |
| V-12 | Token cache dead code (never imported)                                    | Voice26 P5     | S2     |
| V-13 | CORS missing X-CSRF-Token header                                          | Voice26 P6     | S8     |
| V-14 | Admin redirect drops query params (S8-T2)                                 | Voice26 P7     | S8     |
| V-15 | PCM16 config has no effect in WebRTC (dead config)                        | VoiceArch §2.5 | S9     |
| D-11 | 220+ inline Loader2 spinners, no shared component                         | Dup B1         | S6     |
| D-12 | Three `sanitizeFilename()` identical implementations                      | Dup D3         | S7     |
| D-13 | Three `formatDate()` and two `formatTime()` with different output         | Dup D2         | S7     |
| D-14 | 25 API routes with manual auth instead of pipe()                          | Dup E1         | S8     |
| D-15 | Two rate limit variants (sync/async) used inconsistently                  | Dup E2         | S8     |
| D-16 | Ownership check duplicated in 4 conversation routes                       | Dup E3         | S8     |
| D-17 | API error response format not standardized                                | Dup E4         | S8     |
| D-18 | Three character card components                                           | Dup A3         | S6     |
| D-19 | Voice enabled differently for maestri vs coach/buddy                      | Dup A4         | S6     |
| D-20 | 23+ direct localStorage calls violating policy                            | Dup F3         | S5     |
| D-21 | API calls duplicated without caching (12 callers for /api/realtime/token) | Dup F4         | S5     |
| D-22 | Two auto-save-wrappers.tsx files                                          | Dup B3         | S6     |
| D-23 | Hardcoded Italian strings in code (export-helpers, scheduler, components) | Dup C4         | S4     |

### LOW (P3) — Fix when convenient

| ID   | Issue                                                       | Source         | Stream |
| ---- | ----------------------------------------------------------- | -------------- | ------ |
| D-24 | Dialog/modal: TOS bypasses wrapper (1 file)                 | Dup B2         | S6     |
| D-25 | Typing data types duplicated (dead code)                    | Dup D4         | S9     |
| D-26 | 13 error classes without common base                        | Dup D5         | S7     |
| D-27 | 5 header variants only for maestri (possible dead A/B test) | Dup A6         | S6     |
| D-28 | System prompt static vs dynamic (by design, needs docs)     | Dup A7         | S6     |
| D-29 | Knowledge base only for maestri (by design, needs docs)     | Dup A8         | S6     |
| V-16 | WebSocket proxy dead code (src/server/realtime-proxy/)      | VoiceArch §6.4 | S9     |
| V-17 | Transport probe/selector/switcher dead code                 | VoiceArch §6.4 | S9     |
| V-18 | Audio playback queue dead code                              | VoiceArch §6.4 | S9     |

---

<a id="stream-1"></a>

## 2. STREAM 1 — VOICE: SAFETY + PERSONALITY

**Issues**: V-01, V-02
**Priority**: CRITICAL — Ship first
**Deadline**: ASAP (safety gap in production)

### Problem Summary

Voice sessions have ZERO safety guardrails. Chat has 5 layers (ADR 0004); voice has none.
Additionally, `buildVoicePrompt()` truncates systemPrompt from ~8000 chars to ~2000 chars,
stripping 75% of personality/pedagogy. All characters sound generic in voice mode.

Azure Realtime API supports ~12k chars of instructions. The 2000 char limit has no technical
justification. The knowledge base is NOT in the systemPrompt (it's in separate `*-knowledge.ts`
files loaded by RAG), so the entire systemPrompt is personality/safety content that should NOT
be cut.

### Fix Plan

#### S1-T1: Remove voice prompt truncation

**File**: `src/lib/hooks/voice-session/voice-prompt-builder.ts`

- Remove `MAX_VOICE_PROMPT_CHARS = 2000` limit
- Pass full `systemPrompt` through (strip only knowledge base references if present)
- Keep voice-specific adaptations (spoken language style, no markdown, etc.)

#### S1-T2: Inject safety guardrails into voice instructions

**File**: `src/lib/hooks/voice-session/session-config.ts`

- Import `SAFETY_CORE_PROMPT` from `src/lib/safety/safety-prompts-core.ts` (pure text, no server deps)
- Inject safety prompt into voice instructions alongside full systemPrompt
- Note: `session-config.ts` is `'use client'`, so use the text constant, not `injectSafetyGuardrails()` which has server deps

**Before**:

```typescript
const voicePrompt = buildVoicePrompt(maestro); // only 2000 chars
const fullInstructions =
  languageInstruction +
  characterInstruction +
  memoryContext +
  adaptiveInstruction +
  voicePrompt +
  voicePersonality +
  TOOL_USAGE_INSTRUCTIONS;
```

**After**:

```typescript
import { SAFETY_CORE_PROMPT } from '@/lib/safety/safety-prompts-core';
const safePrompt = SAFETY_CORE_PROMPT + '\n\n' + maestro.systemPrompt;
const fullInstructions =
  languageInstruction +
  characterInstruction +
  safePrompt +
  memoryContext +
  adaptiveInstruction +
  voicePersonality +
  TOOL_USAGE_INSTRUCTIONS;
```

#### S1-T3: Add transcript-based safety net (Level 2)

**File**: `src/lib/hooks/voice-session/event-handlers.ts`

On user transcript (`conversation.item.input_audio_transcription.completed`):

- Run lightweight content filter on transcript text
- If blocked: send `response.cancel` + redirect to safe response via data channel

On AI transcript (`response.audio_transcript.done`):

- Run bias detection on AI response
- Check for crisis keywords
- Log violations via compliance-audit-service
- Note: this reacts AFTER audio plays (~1-2s delay) — cannot prevent, but can log + redirect next response

#### S1-T4: Update tests

- Update `voice-prompt-builder.test.ts` for new behavior (no truncation)
- Create `voice-safety.test.ts` for transcript safety integration

### Verification

- Voice characters speak with their actual personality (not generic)
- Safety guardrails present in voice instructions
- Transcript safety logging active
- All existing tests pass

---

<a id="stream-2"></a>

## 3. STREAM 2 — VOICE: GA PROTOCOL MIGRATION

**Issues**: V-03, V-04, V-05, V-08, V-09, V-10, V-11, V-12, V-15
**Priority**: CRITICAL — Preview deprecated 30 April 2026
**Deadline**: Before 30 April 2026 (2.5 months runway)

### Breaking Changes Summary

| Component          | Preview (current)                                                       | GA (required)                                                       |
| ------------------ | ----------------------------------------------------------------------- | ------------------------------------------------------------------- |
| Token endpoint     | `POST /openai/realtimeapi/sessions?api-version=2025-04-01-preview`      | `POST /openai/v1/realtime/client_secrets`                           |
| WebRTC SDP         | `POST https://{region}.realtimeapi-preview.ai.azure.com/v1/realtimertc` | `POST https://{resource}.openai.azure.com/openai/v1/realtime/calls` |
| Session config     | Sent as `session.update` after connection                               | Sent WITH `client_secrets` request                                  |
| Event: text delta  | `response.text.delta`                                                   | `response.output_text.delta`                                        |
| Event: audio delta | `response.audio.delta`                                                  | `response.output_audio.delta`                                       |
| Event: transcript  | `response.audio_transcript.delta`                                       | `response.output_audio_transcript.delta`                            |
| session.update     | No type field                                                           | Requires `type: "realtime"`                                         |
| API version        | `api-version=2025-04-01-preview` in URL                                 | No api-version, uses `/openai/v1/` path                             |

### Connection Optimization (bundled with migration)

| Optimization                                                      | Latency saved    |
| ----------------------------------------------------------------- | ---------------- |
| Remove STUN servers + ICE gathering wait                          | ~300-500ms       |
| Eliminate GET /api/realtime/token (unnecessary fetch)             | ~100-300ms       |
| Session config in client_secrets (skip session.update round-trip) | ~400-600ms       |
| Parallelize memory + adaptive context fetch                       | ~200-400ms       |
| Use resource endpoint (not regional)                              | ~50-100ms        |
| Remove 300ms greeting delay                                       | ~300ms           |
| **TOTAL**                                                         | **~1350-2200ms** |

**Expected result**: ~1.0-1.2s connection (desktop) vs current ~3.0-3.5s

### Fix Plan

#### S2-T1: Update ephemeral token route (server)

**File**: `src/app/api/realtime/ephemeral-token/route.ts`

- Change URL to `/openai/v1/realtime/client_secrets`
- Remove `api-version` parameter
- Include session config (instructions, voice, model) in request body
- Return `webrtcEndpoint` in response (deterministic: `https://{resource}.openai.azure.com/openai/v1/realtime/calls`)

#### S2-T2: Update WebRTC connection (client)

**File**: `src/lib/hooks/voice-session/webrtc-connection.ts`

- Remove ICE servers: `new RTCPeerConnection()` (no config)
- Remove ICE gathering wait (send offer immediately after `setLocalDescription()`)
- Remove double fetch in `exchangeSDP()` — get `webrtcEndpoint` from token response
- Simplify SDP exchange to single POST

**File**: `src/lib/hooks/voice-session/webrtc-types.ts`

- Remove `ICE_SERVERS` export
- Update `EphemeralTokenResponse` to include `webrtcEndpoint`

#### S2-T3: Pre-fetch context in parallel

**File**: `src/lib/hooks/voice-session/connection.ts`

- Run `getUserMedia()`, `fetchConversationMemory()`, `GET /api/adaptive/context`, and `POST client_secrets` in parallel with `Promise.all()`

**File**: `src/lib/hooks/voice-session/session-config.ts`

- Simplify: session config sent with token, only greeting needed after connection
- Remove sequential fetches
- Add `type: "realtime"` to any remaining `session.update`

#### S2-T4: Update event handlers

**File**: `src/lib/hooks/voice-session/event-handlers.ts`

- Map to GA event names:
  - `response.text.delta` → `response.output_text.delta`
  - `response.audio.delta` → `response.output_audio.delta`
  - `response.audio_transcript.delta` → `response.output_audio_transcript.delta`
- Keep backward compat handlers during transition if needed

#### S2-T5: Update token route (server)

**File**: `src/app/api/realtime/token/route.ts`

- Update `webrtcEndpoint` to `/v1/realtime/calls` on resource domain
- Remove regional endpoint reference
- Consider merging into ephemeral-token route

#### S2-T6: Update CSP

**File**: `src/proxy.ts`

- Remove `*.realtimeapi-preview.ai.azure.com` from CSP connect-src
- Keep `https://*.openai.azure.com` and `wss://*.openai.azure.com`

#### S2-T7: Remove dead voice config and token cache

- Remove `input_audio_format`/`output_audio_format` from session.update (PCM16 has no effect in WebRTC)
- **Decision: REMOVE `token-cache.ts`** (dead code). GA flow sends session config with `client_secrets` request, making the current token-cache approach obsolete. The ephemeral token is single-use per session in GA. Pre-fetching happens via `Promise.all()` in S2-T3 instead.

### New GA Features (evaluate post-migration)

| Feature            | Description                                                    | Action                                       |
| ------------------ | -------------------------------------------------------------- | -------------------------------------------- |
| `?webrtcfilter=on` | Limits data channel events (hides instructions)                | Do NOT enable — tool calls need data channel |
| WebSocket Observer | Server-side sideband connection to monitor/control WebRTC call | Evaluate for compliance recording            |
| GA models          | `gpt-realtime` (premium), `gpt-realtime-mini` (cost-optimized) | Map to tiers: Trial/Base=mini, Pro=premium   |

### Verification

- Voice connects in <1.5s (desktop)
- All 26 maestri voice sessions work
- No console errors related to deprecated endpoints
- CSP clean (no preview domain references)

---

<a id="stream-3"></a>

## 4. STREAM 3 — VOICE: UX (GREETINGS + PHONE RING)

**Issues**: V-06, V-07
**Priority**: HIGH

### Part A: Multilingual Greetings

#### Problem

`createActiveCharacter()` never passes language parameter. Defaults to `"it"`.
Coaches and maestri use static `.greeting` field (hardcoded Italian) instead of `getGreeting()`.
Formal professors use informal "tu" (aiutarti) instead of formal "Lei" (esserLe utile).

#### Fix Plan

**S3-T1**: `src/lib/stores/conversation-flow-store/slices/character-slice.ts:141`

- Pass `locale` from `useLocale()` to `createActiveCharacter()`

**S3-T2**: `src/lib/stores/conversation-flow-store/helpers.ts`

- Line 44 (coaches): call `coach.getGreeting({language})` instead of `coach.greeting`
- Line 49 (maestri): call `maestro.getGreeting({language})` instead of `maestro.greeting`
- Keep `.greeting` as fallback only

**S3-T3**: Verify all 26 maestri `.ts` files have formal Italian greeting as fallback

- **16 of 26 already modified** (see Appendix O for list): cassese, cicerone, curie, darwin, erodoto, euclide, galileo, humboldt, ippocrate, leonardo, lovelace, manzoni, mozart, shakespeare, smith, socrate
- **10 remaining**: alex-pina, cervantes, chris, feynman, goethe, levi-montalcini, mascetti, moliere, omero + verify all 16 modified are correct

**S3-T4**: `src/lib/stores/conversation-flow-store/slices/session-slice.ts`

- Pass locale to any session initialization that creates greetings

### Part B: Phone Ring UX Pattern (post-GA migration)

**Depends on**: Stream 2 (GA migration)

Connection time after GA migration: ~1.0-1.2s. Phone ring masks this entirely.

**S3-T5**: Create `src/components/voice/calling-overlay.tsx`

- Ring animation (pulsing avatar like WhatsApp/FaceTime)
- Show maestro name and subject
- Ring sound (gentle, warm — custom "MirrorBuddy ring")

**S3-T6**: Create `src/lib/hooks/voice-session/use-calling-state.ts`

- State machine: idle → ringing → connected → ended
- Minimum 1 full ring before "answering" (even if connection is fast)
- Timeout: >8s show "Still connecting...", 15s (desktop) / 60s (mobile) show error

**S3-T7**: Add `public/sounds/ring-tone.mp3`

**S3-T8**: Accessibility

- `prefers-reduced-motion`: static "Calling..." text
- Screen reader: "Calling [Maestro name]. Please wait."
- Auditory impairment profile: visual-only (no ring sound)

### Verification

- German user sees "Guten Tag! Ich bin Galileo..." not "Ciao!"
- Formal professors use Lei/Sie/Vous
- Phone ring masks entire connection wait
- Accessible per all 7 DSA profiles

---

<a id="stream-4"></a>

## 5. STREAM 4 — i18n CLEANUP

**Issues**: D-06, D-07, D-09, D-10, D-23
**Priority**: HIGH (D-06 breaks 8 components in production)

### Fix Plan

#### S4-T1: Add missing namespaces to NAMESPACES array [URGENT]

**File**: `src/i18n/request.ts`

- Add `'voice'` to NAMESPACES array (8 components use `useTranslations('voice')`)
- Add `'analytics'` to NAMESPACES array (2 components use it)

#### S4-T2: Delete dead i18n config at root

**File**: `i18n/config.ts` (root) — DELETE

- Not imported by any file (0 imports found)
- Different locale order from `src/i18n/config.ts` — confusing
- Missing `localeFlags` that 14 files need

#### S4-T3: Delete or regenerate aggregated i18n messages

**Directory**: `src/i18n/messages/` — DELETE (5 files, ~585KB for it.json alone)

- Not imported by any source file
- Diverges from `messages/{locale}/` namespace files (9 missing, 20 extra namespaces)
- Source of truth is `messages/{locale}/{namespace}.json`

#### S4-T4: Clean up unused namespace JSON files

**Files to evaluate for deletion** (0 references in code):

- `messages/{locale}/session.json`
- `messages/{locale}/onboarding.json`
- `messages/{locale}/email.json`
- `messages/{locale}/research.json`

#### S4-T5: Audit hardcoded Italian strings (medium term)

**Known locations**:

- `src/lib/export/export-helpers.ts:23-39` — tool type labels ("Mappa Mentale", "Riassunto")
- `src/lib/scheduler/formatting.ts:33` — day names ("Domenica", "Lunedì"...)
- `src/components/settings/settings-page-mobile.tsx:241` — "Salva modifiche"
- `src/components/contact/enterprise-form.tsx:103` — "Errore durante l'invio"
- `src/components/tools/tool-canvas.tsx:142` — 'Errore'
- `src/components/conversation/components/voice-call-panel.tsx:82` — 'Errore di connessione vocale'
- `src/components/study-kit/StudyKitUpload.tsx:86` — 'Errore durante la generazione'

Priority: export-helpers labels (users download these), then error messages.

### Verification

- `useTranslations('voice')` returns actual translations (not empty/raw keys)
- `useTranslations('analytics')` returns actual translations
- `npm run i18n:check` passes
- No dead i18n files at root or in `src/i18n/messages/`

---

<a id="stream-5"></a>

## 6. STREAM 5 — STATE MANAGEMENT CONSOLIDATION

**Issues**: D-01, D-02, D-20, D-21
**Priority**: CRITICAL (D-02 = GDPR risk)

### S5-A: Consent Systems Consolidation

**Problem**: 4 consent systems in `src/lib/consent/`:

1. `unified-consent-storage.ts` — key `mirrorbuddy-unified-consent`
2. `consent-storage.ts` — key `mirrorbuddy-consent`
3. `trial-consent.ts` — via variable
4. `consent-store.ts` — Zustand in-memory

`unified-consent-storage.ts` already has migration logic from `mirrorbuddy-consent`.
But `consent-storage.ts` still exists and is used.

**GDPR risk**: Revoking consent in one system doesn't propagate to the other three.

#### Fix Plan

**S5-T1**: Audit all consent consumers

- Map which files import from each consent module
- Identify the true "source of truth"

**S5-T2**: Consolidate into single Zustand store

- `consent-store.ts` as the single runtime store
- `unified-consent-storage.ts` for persistence (already has migration)
- Delete `consent-storage.ts` after migrating consumers
- Wire `trial-consent.ts` into the unified store

### S5-B: Conversation Stores Consolidation

**Problem**: Two stores manage conversations and messages:

- `useConversationStore` (8 consumers): messages, persistence, syncToServer
- `useConversationFlowStore` (10 consumers): session lifecycle, character routing, handoff

Both write messages — can diverge.

#### Fix Plan

**S5-T3**: Merge into `useConversationFlowStore` as primary store

**Migration strategy (3 phases)**:

1. **Phase A — Dual-write**: Add `syncToServer()` and `addMessage()` to `useConversationFlowStore` (copied from `useConversationStore`). Both stores write messages for 1 sprint. Add Sentry logging if stores diverge (`if (flowStore.messages.length !== convStore.messages.length) logDivergence()`).

2. **Phase B — Consumer migration**: Update 8 consumers of `useConversationStore` to import from `useConversationFlowStore` instead. One file at a time, verify each with existing tests.

3. **Phase C — Deletion**: After 1 week of clean dual-write (zero divergence events in Sentry), delete `conversation-store.ts`.

**Rollback**: If divergence detected during Phase A, revert `useConversationFlowStore` changes and keep both stores until root cause identified.

- Consumers to migrate: `use-character-chat/index.ts`, `store-sync.ts`, + 6 chat hook files
- Delete `conversation-store.ts` only after Phase C confirmation

### S5-C: localStorage Policy Violations

**Problem**: 23+ direct `localStorage` calls violating "NO localStorage for user data" policy.

**S5-T4**: Audit and migrate

- `use-permissions.ts:43,55` — user permissions → Zustand
- `transport-cache.ts:56,77,146,167` — connection probes → will be deleted in S2 (dead code)
- `email-capture-prompt.tsx:47,63,93` — session ID + dismissal → Zustand
- `ios-install-banner.tsx:47,62` — banner dismissal → Zustand

### S5-D: API Call Deduplication

**Problem**: Same endpoints called from many components without caching:

- `/api/realtime/token` — 12 callers
- `/api/user/usage` — 8 callers
- `/api/azure/costs` — 3+ callers (2 parallel in same component)

**S5-T5**: Implement request deduplication

- Option A: React Query / SWR (recommended for long term)
- Option B: Custom `useCachedFetch` hook with dedup (lighter)
- Start with highest-traffic endpoints

### Verification

- Single consent revocation propagates everywhere
- No divergent conversation state between stores
- `grep -r "localStorage\." src/` shows only consent-related hits
- No duplicate API calls in network tab

---

<a id="stream-6"></a>

## 7. STREAM 6 — UI DEDUPLICATION

**Issues**: D-03, D-04, D-05, D-11, D-18, D-19, D-22, D-24, D-27, D-28, D-29
**Priority**: HIGH for feature parity (D-03, D-04, D-05), MEDIUM for DRY (D-11)

### S6-A: Unified Chat Architecture (long term)

**Problem**: Three separate chat implementations:

- `MaestroSession` (271 lines) — 26 maestri: has TTS, voice, 5 header variants; no handoff
- `CharacterChatView` (216 lines) — 6 coach + 6 buddy: has handoff, voice; no TTS
- `materiali-conversation/` (633 lines) — education module: no TTS, voice, or handoff

The backend is already unified (single `/api/chat`, single `character-router`).

#### Fix Plan (phased)

**S6-T1**: Unify message bubble (quick win)

- Create single `<MessageBubble>` with optional props: `ttsEnabled`, `showVoiceBadge`, `showAttachments`
- Replace 3 existing bubble components
- Gives TTS to coach/buddy for free

**S6-T2**: Add handoff to MaestroSession (medium term)

- Import handoff logic from `conversation-flow.tsx`
- Enable emotional support referral when student needs it

**S6-T3**: Unify into `<UnifiedChatView characterType={type}>` (long term)

- Data-driven variations based on character type
- MaestroSession comment already says "Unified conversation layout matching Coach/Buddy pattern"

### S6-B: Spinner Component

**S6-T4**: Create `src/components/ui/spinner.tsx`

```typescript
export function Spinner({ size = 'md' }: { size?: 'sm' | 'md' | 'lg' }) {
  const sizes = { sm: 'w-4 h-4', md: 'w-5 h-5', lg: 'w-8 h-8' };
  return <Loader2 className={`${sizes[size]} animate-spin`} />;
}
```

- Then gradually replace 220+ inline `Loader2` usages

### S6-C: Character Cards

**S6-T5**: Evaluate unification of 3 character card components

- `MaestroCard`, `CharacterCard` (conversation), `CharacterCard` (education)
- May have legitimate UI differences — assess before merging

### S6-D: Auto-Save Wrappers

**S6-T6**: Delete `src/components/tools/auto-save-wrappers.tsx` (282 lines)

- Keep only `src/components/tools/tool-result-display/auto-save-wrappers.tsx` (300 lines, more features)
- Migrate the one consumer (`tool-content-renderers.tsx`)

### Verification

- TTS works in coach/buddy message bubbles
- Handoff available from MaestroSession
- Spinner component used in new code (gradual migration OK for existing)
- No duplicate auto-save-wrappers

---

<a id="stream-7"></a>

## 8. STREAM 7 — SERVICES & UTILITY CONSOLIDATION

**Issues**: D-08, D-12, D-13, D-26
**Priority**: HIGH for D-08 (inconsistent levels), MEDIUM for rest

### S7-T1: Consolidate `calculateLevel()` functions

**Problem**: 4 functions with same name, different algorithms:

- `utils.ts:22` — thresholds array [0,100,250,500,1000,...64000]
- `gamification-helpers.ts:18` — `Math.floor(points / 1000) + 1`, max 100
- `xp-rewards.ts:139` — `XP_PER_LEVEL` array reverse lookup
- `method-progress-utils.ts:19` — returns skill level string

**Impact**: XP=500 gives level 4, 1, or something else depending on which function is called.

**Fix**: Create `src/lib/gamification/level-calculator.ts` with explicit functions:

- `calculateXPLevel(xp)` — for XP display
- `calculateGamificationLevel(points)` — for gamification system
- `calculateSkillLevel(progress)` — for method progress
- Delete redundant implementations, update all callers

### S7-T2: Consolidate `sanitizeFilename()`

**3 identical implementations**:

- `src/lib/export/export-helpers.ts:16`
- `src/lib/tools/accessible-print/helpers.ts:14`
- `src/lib/tools/mindmap-export/helpers.ts:8`

**Fix**: Single export from `src/lib/utils.ts`, update 3 import sites.

### S7-T3: Consolidate date/time formatting

**3 `formatDate()` + 2 `formatTime()`** with different output:

- `utils.ts` — "14 febbraio 2026" (numeric-long-numeric)
- `scheduler/formatting.ts` — "sabato 14 febbraio" (weekday, no year)
- `export-helpers.ts` — "14 febbraio 2026" (2digit forces leading zero)
- `utils.ts` `formatTime(seconds)` — "3:45" (M:SS from seconds)
- `scheduler/formatting.ts` `formatTime(date)` — "15:30" (HH:MM from Date)

**Fix**: Create `src/lib/formatting/dates.ts` with explicit variants:

- `formatDateFull(date)` — "14 febbraio 2026"
- `formatDateWithWeekday(date)` — "sabato 14 febbraio"
- `formatDuration(seconds)` — "3:45"
- `formatTimeOfDay(date)` — "15:30"

### Verification

- `calculateLevel` calls produce consistent results per context
- No duplicate `sanitizeFilename` in codebase
- Date formatting is consistent per use case
- All tests pass

---

<a id="stream-8"></a>

## 9. STREAM 8 — API STANDARDIZATION

**Issues**: V-13, V-14, D-14, D-15, D-16, D-17
**Priority**: MEDIUM

### S8-T1: CORS fix (quick win)

**File**: `src/lib/security/cors-config.ts:62`

- Add `X-CSRF-Token, x-csrf-token` to `Access-Control-Allow-Headers`
- One-line fix

### S8-T2: Admin redirect fix (quick win)

**File**: `src/proxy.ts:303`

- Preserve query params: `adminUrl.search = new URL(request.url).search;`
- One-line fix

### S8-T3: Migrate non-streaming routes to pipe() (medium term)

25 routes use `validateAuth()` directly. Non-streaming routes that should use pipe():

- `src/app/api/user/route.ts`
- `src/app/api/onboarding/handlers.ts`
- `src/app/api/scheduler/helpers.ts`
- `src/app/api/telemetry/events/route.ts`
- `src/app/api/safety/events/route.ts`

Streaming routes (`tools/stream`, `tools/sse`, `chat/stream`) have technical reasons
to not use pipe(). For those: create `withAuthStreaming` middleware.

### S8-T4: Standardize API error response format

Create shared type:

```typescript
interface ApiErrorResponse {
  error: string;
  details?: string;
  validation?: string[];
}
```

Gradually adopt across routes.

### S8-T5: Extract conversation ownership check

Create `requireConversationOwnership(conversationId, userId)` utility.
Replace duplicated pattern in 4 conversation routes.

### Verification

- No CORS console errors on telemetry
- Admin RSC navigation works (no 404)
- All migrated routes have Sentry wrapping + CSRF check
- Error responses follow standard format

---

<a id="stream-9"></a>

## 10. STREAM 9 — DEAD CODE REMOVAL

**Issues**: D-25, V-15, V-16, V-17, V-18
**Priority**: LOW (no functional impact, reduces confusion)

### Files to Delete

| File/Directory                                         | Reason                                                    | Blocked by |
| ------------------------------------------------------ | --------------------------------------------------------- | ---------- |
| `src/types/tools/typing-data-types.ts`                 | Not imported, duplicates `tool-data-types-educational.ts` | Nothing    |
| `src/lib/hooks/voice-session/audio-playback.ts`        | Dead code in WebRTC mode                                  | Nothing    |
| `src/lib/hooks/voice-session/audio-playback-types.ts`  | Dead code                                                 | Nothing    |
| `src/lib/hooks/voice-session/ring-buffer.ts`           | Dead code                                                 | Nothing    |
| `src/lib/hooks/voice-session/transport-probe.ts`       | No WebSocket fallback in GA                               | Stream 2   |
| `src/lib/hooks/voice-session/transport-selector.ts`    | Dead code                                                 | Stream 2   |
| `src/lib/hooks/voice-session/transport-switcher.ts`    | Dead code                                                 | Stream 2   |
| `src/lib/hooks/voice-session/transport-cache.ts`       | Dead code                                                 | Stream 2   |
| `src/server/realtime-proxy/`                           | Deprecated WebSocket proxy                                | Stream 2   |
| `src/lib/hooks/voice-session/audio-polling-helpers.ts` | Verify if only used by playback                           | Stream 2   |

### Config to Remove

- `input_audio_format`/`output_audio_format` from session.update (no effect in WebRTC)
- `AZURE_OPENAI_REALTIME_REGION` env var (GA uses resource endpoint directly)
- `ICE_SERVERS` export from `webrtc-types.ts` (GA needs none)

### Verification

- `npm run build` passes
- No broken imports
- All tests pass

---

<a id="execution-waves"></a>

## 11. EXECUTION WAVES

### Parallelization Guide

```
Wave 0 (Quick Wins) ─── can start immediately
    │
    ├── Wave 1 (Safety)  ──────┐
    │                          │
    ├── Wave 2 (Greetings) ────┤── all 3 independent, can run in parallel
    │                          │
    └── Wave 3 (GA Phase 1) ───┘
                │
                v
         Wave 4 (GA Phase 2)  ── depends on Wave 3
                │
                v
    ┌── Wave 5 (i18n + State) ─────┐
    │                               │
    ├── Wave 6 (Services + API) ───┤── all 4 independent, can run in parallel
    │                               │
    ├── Wave 7 (UI + Phone Ring*) ─┤── *Phone Ring depends on Wave 4
    │                               │
    └── Wave 8 (Architecture) ─────┘── S5-T3 depends on Wave 5, S6-T2/T3 depend on Wave 7
                │
                v
         Wave 9 (Dead Code) ── depends on Wave 4 (transport files)
```

### Wave 0 — Quick Wins (no risk, immediate value)

| Task                                         | Stream | Files | Impact                     |
| -------------------------------------------- | ------ | ----- | -------------------------- |
| S4-T1: Add `voice`+`analytics` to NAMESPACES | S4     | 1     | Fixes 10 broken components |
| S4-T2: Delete `i18n/config.ts` (root)        | S4     | 1     | Remove dead code           |
| S8-T1: CORS add X-CSRF-Token                 | S8     | 1     | Fix console errors         |
| S8-T2: Admin redirect preserve query params  | S8     | 1     | Fix 404s                   |
| D-25: Delete `typing-data-types.ts`          | S9     | 1     | Remove dead code           |

### Wave 1 — Voice Safety + Personality (CRITICAL)

| Task                                         | Stream | Files | Depends on   |
| -------------------------------------------- | ------ | ----- | ------------ |
| S1-T1: Remove voice prompt truncation        | S1     | 1     | Nothing      |
| S1-T2: Inject safety into voice instructions | S1     | 1     | S1-T1        |
| S1-T3: Transcript safety net                 | S1     | 1     | Nothing      |
| S1-T4: Tests                                 | S1     | 2     | S1-T1, S1-T2 |

### Wave 2 — Multilingual Greetings

| Task                                            | Stream | Files | Depends on |
| ----------------------------------------------- | ------ | ----- | ---------- |
| S3-T1: Pass locale to createActiveCharacter     | S3     | 1     | Nothing    |
| S3-T2: Use getGreeting() for coaches/maestri    | S3     | 1     | S3-T1      |
| S3-T3: Verify formal Italian fallback greetings | S3     | 26    | Nothing    |
| S3-T4: Session slice locale pass-through        | S3     | 1     | S3-T1      |

### Wave 3 — GA Protocol Migration (Phase 1: Endpoints)

| Task                                | Stream | Files | Depends on   |
| ----------------------------------- | ------ | ----- | ------------ |
| S2-T1: Update ephemeral token route | S2     | 1     | Nothing      |
| S2-T5: Update token route           | S2     | 1     | Nothing      |
| S2-T4: Update event handlers        | S2     | 1     | Nothing      |
| S2-T6: Update CSP                   | S2     | 1     | S2-T1, S2-T5 |

### Wave 4 — GA Protocol Migration (Phase 2: Connection Optimization)

| Task                                              | Stream | Files | Depends on |
| ------------------------------------------------- | ------ | ----- | ---------- |
| S2-T2: Remove ICE + gathering wait + double fetch | S2     | 2     | Wave 3     |
| S2-T3: Parallelize context fetches                | S2     | 2     | Wave 3     |
| S2-T7: Remove dead voice config                   | S2     | 2     | Wave 3     |

### Wave 5 — i18n + State Management

| Task                                   | Stream | Files | Depends on |
| -------------------------------------- | ------ | ----- | ---------- |
| S4-T3: Delete aggregated i18n messages | S4     | 5     | Nothing    |
| S4-T4: Clean unused namespace JSONs    | S4     | ~20   | S4-T1      |
| S5-T1+T2: Consolidate consent systems  | S5     | ~6    | Nothing    |
| S5-T4: Migrate localStorage violations | S5     | ~4    | Nothing    |

### Wave 6 — Services + API Consolidation

| Task                                        | Stream | Files | Depends on |
| ------------------------------------------- | ------ | ----- | ---------- |
| S7-T1: Consolidate calculateLevel           | S7     | ~5    | Nothing    |
| S7-T2: Consolidate sanitizeFilename         | S7     | 3     | Nothing    |
| S7-T3: Consolidate date/time formatting     | S7     | ~4    | Nothing    |
| S8-T5: Extract conversation ownership check | S8     | 4     | Nothing    |

### Wave 7 — UI Unification + Phone Ring

| Task                                       | Stream | Files     | Depends on |
| ------------------------------------------ | ------ | --------- | ---------- |
| S6-T1: Unified message bubble              | S6     | ~4        | Nothing    |
| S6-T4: Spinner component                   | S6     | 1+gradual | Nothing    |
| S6-T6: Remove duplicate auto-save-wrappers | S6     | 2         | Nothing    |
| S3-T5+T6+T7+T8: Phone ring UX              | S3     | 4 new     | Wave 4     |

### Wave 8 — Long-Term Architecture

| Task                                   | Stream | Files | Depends on |
| -------------------------------------- | ------ | ----- | ---------- |
| S6-T2: Handoff in MaestroSession       | S6     | ~3    | Wave 7     |
| S6-T3: Unified ChatView                | S6     | ~10   | Wave 7     |
| S5-T3: Merge conversation stores       | S5     | ~18   | Wave 5     |
| S5-T5: API call deduplication          | S5     | ~15   | Nothing    |
| S4-T5: Hardcoded Italian strings audit | S4     | ~20   | Nothing    |
| S8-T3: Migrate routes to pipe()        | S8     | ~10   | Nothing    |
| S8-T4: Standardize error format        | S8     | ~25   | Nothing    |

### Wave 9 — Dead Code Cleanup

| Task             | Stream | Files | Depends on               |
| ---------------- | ------ | ----- | ------------------------ |
| All S9 deletions | S9     | ~10   | Wave 4 (transport files) |

---

<a id="acceptance-criteria"></a>

## 12. ACCEPTANCE CRITERIA

### Voice (Streams 1, 2, 3)

- [ ] **V-01/V-02 fixed**: Test with Cicerone (longest prompt, 8321 chars). Voice character should speak with distinct personality, use formal Italian, reference subject matter. Verify `grep -r "SAFETY_CORE_PROMPT" src/lib/hooks/voice-session/` returns match.
- [ ] **V-03-V-05 fixed**: `grep -r "realtimeapi-preview\|2025-04-01-preview" src/` returns zero results. All API calls use `/openai/v1/` paths.
- [ ] **Connection latency**: Measure with Chrome DevTools Network tab. WebRTC connection < 1.5s (desktop). Run 5 times, take median.
- [ ] **V-06/V-07 fixed**: Switch locale to `de`, open Galileo voice session. Greeting must start with "Guten Tag" (not "Ciao"). Formal professors use Sie.
- [ ] **Phone ring**: Click voice call button. Ring sound plays immediately. Ring stops when connection ready. Verify with `prefers-reduced-motion: reduce` — should show static "Calling..." text.

### i18n (Stream 4)

- [ ] **D-06 fixed**: Open any component using `useTranslations('voice')` (e.g., voice-call-panel). UI shows actual translations, not raw keys or empty strings.
- [ ] **D-07 fixed**: Analytics components render translated labels.
- [ ] **Dead code removed**: `ls i18n/config.ts` returns "not found". `ls src/i18n/messages/` returns "not found". `ls src/types/tools/typing-data-types.ts` returns "not found".
- [ ] `npm run i18n:check` passes clean.

### State Management (Stream 5)

- [ ] **D-02 fixed**: Revoke cookie consent in settings. Verify `mirrorbuddy-unified-consent`, `mirrorbuddy-consent`, and Zustand store all reflect revocation. `grep -r "consent-storage" src/lib/consent/` returns zero results (file deleted).
- [ ] **D-01 fixed**: `grep -r "useConversationStore" src/` returns zero results after S5-T3 Phase C.
- [ ] **D-20 fixed**: `grep -rn "localStorage\." src/ --include="*.ts" --include="*.tsx" | grep -v consent | grep -v node_modules` returns only legitimate uses.
- [ ] **D-21 addressed**: Network tab shows max 1 concurrent call to `/api/user/usage` and `/api/realtime/token` across UI.

### UI (Stream 6)

- [ ] **D-04 fixed**: Open Coach Melissa chat, send message. Message bubble shows TTS button (same as maestro). Click it — TTS reads message.
- [ ] **D-05 fixed**: In MaestroSession with Leonardo, when student expresses emotional distress, handoff suggestion appears to redirect to buddy.
- [ ] **D-11**: New components use `<Spinner size="md" />` (verify in code review).

### Services (Stream 7)

- [ ] **D-08 fixed**: `grep -rn "function calculateLevel" src/` returns max 3 results (one per context), all in `src/lib/gamification/level-calculator.ts`.
- [ ] **D-12 fixed**: `grep -rn "sanitizeFilename" src/ | grep "function\|export"` returns exactly 1 definition.
- [ ] **D-13 fixed**: `grep -rn "function formatDate\|function formatTime" src/` — all in `src/lib/formatting/dates.ts`.

### API (Stream 8)

- [ ] **V-13 fixed**: No CORS console errors on `/api/telemetry/events` (test with www vs non-www origin).
- [ ] **V-14 fixed**: Navigate in admin panel. RSC prefetch requests include `?_rsc=...` params. No 404s.
- [ ] **D-17 addressed**: Spot-check 5 API routes — all return `{ error: string, details?: string }` format.

### Cleanup (Stream 9)

- [ ] `ls src/lib/hooks/voice-session/transport-*.ts src/lib/hooks/voice-session/audio-playback*.ts src/server/realtime-proxy/ 2>&1 | grep -v "No such file"` returns empty.
- [ ] `ls src/types/tools/typing-data-types.ts 2>&1` returns "not found".

### Global

- [ ] All existing tests pass: `npm run test:unit` exits 0
- [ ] `npm run release:fast` passes all gates
- [ ] `npm run build` succeeds with zero errors
- [ ] `npm run ci:summary` shows clean

---

<a id="risk-matrix"></a>

## 13. RISK MATRIX

| Risk                                             | Severity     | Probability             | Mitigation                                                             |
| ------------------------------------------------ | ------------ | ----------------------- | ---------------------------------------------------------------------- |
| Preview API deprecated before migration complete | **CRITICAL** | HIGH (deadline: 30 Apr) | Start Wave 3-4 immediately, 2.5 months runway                          |
| Safety gap exploited in voice before fix         | **CRITICAL** | MEDIUM                  | Ship Wave 1 first, before any other work                               |
| Large instructions slow voice first response     | MEDIUM       | LOW                     | Monitor via Sentry; Azure supports ~12k chars                          |
| Consent consolidation breaks existing consents   | MEDIUM       | MEDIUM                  | Test all consent flows; keep migration path                            |
| Conversation store merge causes data loss        | MEDIUM       | LOW                     | Dual-write during transition; extensive testing                        |
| GA model behavior differs from preview           | MEDIUM       | MEDIUM                  | Test all 26 maestri with GA models                                     |
| Unified chat view breaks existing UI             | MEDIUM       | LOW                     | Phased approach: bubble first, then full view                          |
| CSP change breaks production                     | MEDIUM       | LOW                     | Support both domains during transition                                 |
| Hardcoded string audit is incomplete             | LOW          | HIGH                    | ESLint rule `no-hardcoded-italian` catches new; audit catches existing |

---

<a id="adr-updates"></a>

## 14. ADR UPDATES NEEDED

| ADR      | Update                                                                |
| -------- | --------------------------------------------------------------------- |
| ADR 0038 | Supersede with v2 (GA Protocol Migration) — full text in VoiceArch §8 |
| ADR 0004 | Add voice safety section (instruction-level + transcript-based)       |
| ADR 0064 | Document getGreeting() as required path (not static .greeting)        |
| ADR 0069 | Verify VAD config moves to client_secrets                             |
| ADR 0050 | Update for GA model pricing (gpt-realtime-mini)                       |
| NEW      | ADR for unified chat architecture decision                            |
| NEW      | ADR for consent consolidation                                         |
| NEW      | ADR for API error response standard                                   |

---

<a id="statistics"></a>

## 15. STATISTICS

| Category           | Issues | Critical | High   | Medium | Low    |
| ------------------ | ------ | -------- | ------ | ------ | ------ |
| Voice Safety       | 2      | 2        | —      | —      | —      |
| Voice GA Migration | 7      | 3        | 4      | —      | —      |
| Voice UX           | 2      | —        | 2      | —      | —      |
| i18n               | 5      | —        | 4      | —      | 1      |
| State Management   | 4      | 2        | —      | 2      | —      |
| UI Deduplication   | 11     | —        | 3      | 4      | 4      |
| Services           | 4      | —        | 1      | 2      | 1      |
| API                | 5      | —        | —      | 5      | —      |
| Dead Code          | 5      | —        | —      | —      | 5      |
| **TOTAL**          | **45** | **7**    | **14** | **13** | **11** |

---

<a id="appendices"></a>

## 16. APPENDICES — TECHNICAL REFERENCE

## APPENDIX A — APPROVED DECISIONS (from Voice26 §9, 14 Feb 2026)

### Decision 1: Voice Model — Tier-Based Selection

| Tier  | Model             | Cost    |
| ----- | ----------------- | ------- |
| Trial | gpt-realtime-mini | Lowest  |
| Base  | gpt-realtime-mini | Low     |
| Pro   | gpt-realtime      | Premium |

Selection via `tierService.getModelForUserFeature(userId, 'voice')`.

### Decision 2: Voice Override in Accessibility Settings

Users can select a preferred voice that overrides the character default.
Useful for auditory impairment profiles. Available to all tiers.

Implementation: `accessibility-store profiles.ts` add `voicePreference` field,
`session-config.ts` read override, settings UI add voice selector dropdown.

### Decision 3: Transcript Safety Reaction

When safety net detects a violation in voice transcript:

1. Log the event via `compliance-audit-service`
2. Send `response.cancel` + redirect the AI to a safe response
3. Show a visual warning in the voice call UI
4. Do NOT terminate the session (keep the student engaged safely)

---

## APPENDIX B — VOICE ASSIGNMENTS (Current vs Proposed)

### Current Distribution (26 maestri)

| Voice   | Count | Characters                                                                                                                          |
| ------- | ----- | ----------------------------------------------------------------------------------------------------------------------------------- |
| echo    | 14    | alex-pina, cassese, cervantes, cicerone, erodoto, euclide, feynman, galileo, goethe, humboldt, ippocrate, manzoni, moliere, socrate |
| alloy   | 6     | chris, darwin, leonardo, mozart, shakespeare, smith                                                                                 |
| shimmer | 3     | curie, levi-montalcini, lovelace                                                                                                    |
| ash     | 1     | mascetti                                                                                                                            |
| verse   | 1     | omero                                                                                                                               |
| unused  | —     | marin, cedar, ballad, coral, sage                                                                                                   |

### Proposed Distribution (DEFERRED — not in V1 scope)

Voice reassignment is a quality improvement, not a bug fix. Execute AFTER V1 remediation
is complete. Requires A/B testing with users to validate preferences.
When ready, update `voice` field in each `src/data/maestri/{id}.ts` file.

| Voice   | Gender/Tone       | Proposed Characters                  |
| ------- | ----------------- | ------------------------------------ |
| echo    | M, warm           | manzoni, cicerone, cassese, socrate  |
| alloy   | N, balanced       | shakespeare, smith, darwin, euclide  |
| marin   | M, professional   | galileo, humboldt, goethe, cervantes |
| cedar   | M, conversational | feynman, alex-pina, moliere, erodoto |
| ash     | M, expressive     | chris, mascetti, ippocrate, mozart   |
| shimmer | F, energetic      | curie, lovelace                      |
| coral   | F, warm           | levi-montalcini                      |
| verse   | M, narrative      | omero, leonardo                      |

---

## APPENDIX C — GA MODELS AVAILABLE

| Model                          | Version    | Notes                   |
| ------------------------------ | ---------- | ----------------------- |
| `gpt-4o-realtime-preview`      | 2024-12-17 | Preview only            |
| `gpt-4o-mini-realtime-preview` | 2024-12-17 | Preview only            |
| `gpt-realtime`                 | 2025-08-28 | **GA — recommended**    |
| `gpt-realtime-mini`            | 2025-10-06 | **GA — cost-optimized** |
| `gpt-realtime-mini-2025-12-15` | 2025-12-15 | **GA — latest mini**    |

**Regions**: East US 2, Sweden Central (global deployments).

**SDK requirement**: GA requires `openai-node` TypeScript SDK (not Azure-specific).
Microsoft Preview SDKs do NOT support GA protocol.

---

## APPENDIX D — SAFETY LAYERS COMPARISON (Chat vs Voice)

| Safety Layer         | Chat (text)         | Voice (realtime)      |
| -------------------- | ------------------- | --------------------- |
| Safety system prompt | injected            | **MISSING** (V-01)    |
| Input content filter | `filterInput()`     | IMPOSSIBLE on audio\* |
| Output sanitization  | `sanitizeOutput()`  | IMPOSSIBLE on audio\* |
| STEM safety          | `checkSTEMSafety()` | **MISSING** (V-01)    |
| Bias detection       | `detectBias()`      | **MISSING** (V-01)    |
| Crisis detection     | escalation          | **MISSING** (V-01)    |
| Jailbreak detection  | `detectJailbreak()` | **MISSING** (V-01)    |

\*Cannot filter raw audio in WebRTC peer-to-peer connection.
BUT: transcriptions ARE available via data channel — used for Level 2 safety net.

Compliance logging required for:

- EU AI Act Art. 10 bias monitoring
- GDPR Article 35 DPIA audit trail
- Italian L.132/2025 reporting

---

## APPENDIX E — SYSTEM PROMPT MEASUREMENTS

| Maestro  | systemPrompt size | KB in prompt? | Usable for voice |
| -------- | ----------------- | ------------- | ---------------- |
| Cicerone | 8321 chars        | NO (58 chars) | 8263 chars       |
| Galileo  | ~8000 chars       | NO            | ~8000 chars      |
| Feynman  | ~8000 chars       | NO            | ~8000 chars      |

Azure Realtime API supports ~12k chars of instructions.
Current `MAX_VOICE_PROMPT_CHARS = 2000` at `voice-prompt-builder.ts:11` cuts 75%+.

The 2000 char limit keeps ONLY:

- Character header (name, subject, style) ~50 chars
- CHARACTER INTENSITY DIAL ~500-800 chars
- Core Identity ~200-400 chars

It DROPS: personality details, pedagogical approach, formality rules,
communication style, values, behavioral guidelines.

**Size validation (MUST verify before S1-T2)**:

- Largest systemPrompt: Cicerone ~8321 chars
- SAFETY_CORE_PROMPT: ~800-1200 chars (estimate, verify at implementation)
- Voice personality instructions: ~500 chars
- Memory + adaptive context: ~500-1000 chars
- **Estimated total**: ~10000-11000 chars (within 12k limit)
- **If over 12k**: Truncate memory context first (least critical), never safety or personality.

---

## APPENDIX F — CONNECTION TIMELINE (Before/After)

### Before (current Preview protocol)

```
t=0ms      Click "Parla"
t=0ms      getUserMedia() + POST /api/realtime/ephemeral-token (parallel)
t=~400ms   Token + mic ready
t=~420ms   createPeerConnection(STUN servers)
t=~450ms   createOffer + setLocalDescription
t=~700ms   WAIT ICE gathering complete (STUN queries)
t=~900ms   GET /api/realtime/token (unnecessary fetch)
t=~1100ms  POST regional SDP endpoint
t=~1400ms  connectionState = 'connected'
t=~1450ms  Data channel open -> session.update sent
t=~1500ms  fetchConversationMemory (sequential)
t=~1700ms  GET /api/adaptive/context (sequential)
t=~1900ms  session.update assembled and sent
t=~2200ms  session.updated received -> unmute + greeting scheduled
t=~2500ms  setTimeout(sendGreeting, 300ms)
t=~2800ms  Greeting sent -> response.create
t=~3200ms  Maestro starts speaking

TOTAL: ~3.0-3.5 seconds (desktop), ~4-6 seconds (mobile)
```

### After (GA protocol + optimizations + ring UX)

```
t=0ms      Click "Chiama [Maestro]"
t=0ms      RING STARTS (immediate audio+visual feedback)
t=0ms      getUserMedia()                               -+
t=0ms      fetchConversationMemory()                     | ALL
t=0ms      GET /api/adaptive/context                     | PARALLEL
t=0ms      POST /v1/realtime/client_secrets              |
           (includes session config, voice, instructions) -+
t=~400ms   All parallel fetches complete
t=~410ms   createPeerConnection() (no ICE servers)
t=~420ms   addTrack + createDataChannel + createOffer
t=~430ms   setLocalDescription (NO ICE gathering wait)
t=~440ms   POST /v1/realtime/calls (resource endpoint, not regional)
t=~700ms   setRemoteDescription
t=~800ms   connectionState = 'connected'
t=~810ms   RING STOPS
t=~850ms   data channel open -> send greeting immediately
           (session already configured via client_secrets)
t=~1100ms  Maestro starts speaking

TOTAL: ~1.0-1.2 seconds (desktop), ~1.5-2.5 seconds (mobile)
Ring masks: 100% of wait time (user perceives ~0ms dead time)
```

---

## APPENDIX G — CSP CHANGES (Before/After)

### Current CSP (Preview)

```
connect-src 'self'
  https://*.openai.azure.com
  wss://*.openai.azure.com
  https://*.realtimeapi-preview.ai.azure.com;
```

### GA CSP

```
connect-src 'self'
  https://*.openai.azure.com
  wss://*.openai.azure.com;
```

The `*.realtimeapi-preview.ai.azure.com` entry can be **removed** after migration.
GA uses the resource endpoint directly.

**File to modify**: `src/proxy.ts` (CSP header) + run `npm run test:unit -- csp-validation`.

---

## APPENDIX H — PHONE RING UX RESEARCH & EDGE CASES

### Research Data

- **300ms**: Human conversation response threshold. Beyond this, users perceive delay. (Source: AssemblyAI)
- **500ms-1000ms**: Smooth zone. Audio cues make 1000ms feel like 500ms. (Source: Twilio)
- **>2000ms**: Conversation failure zone. Abandonment rates spike 40%+. (Source: Trillet AI Benchmarks 2026)

MirrorBuddy's current connection time (~2-3.5s) is in the "conversation failure zone".

### Ring Alignment with Connection Phases

```
Ring 1 (~0-800ms) ---- Background: getUserMedia + ephemeral token
Ring 2 (~800-1600ms) - Background: createOffer + SDP exchange
Ring 3 (~1600-2400ms) - Background: waitForConnection + session.update
```

### Edge Cases

| Scenario                      | Behavior                                                                       |
| ----------------------------- | ------------------------------------------------------------------------------ |
| Fast connection (<1s)         | Play at least 1 full ring before "answering". Abrupt transitions feel jarring. |
| Browser mic permission dialog | Pause ring animation, show "Waiting for microphone permission..."              |
| Connection failure            | Ring stops, show error with retry button                                       |
| Reconnection (auto-reconnect) | Show "Reconnecting..." with shorter sound cue, NOT full ring                   |
| >8 seconds                    | Show "Still connecting..." message                                             |
| 15s desktop / 60s mobile      | Show error                                                                     |

---

## APPENDIX I — CODE EVIDENCE & EXACT LOCATIONS

### V-01/V-02: Voice safety/prompt truncation

```
grep -r "injectSafetyGuardrails" src/lib/hooks/voice-session/
→ 0 results
```

- Truncation limit: `src/lib/hooks/voice-session/voice-prompt-builder.ts:11` → `MAX_VOICE_PROMPT_CHARS = 2000`
- Safety injection point: `src/lib/hooks/voice-session/session-config.ts:140`
- Safety constant: `src/lib/safety/safety-prompts-core.ts` → `SAFETY_CORE_PROMPT`

### V-08/V-09: ICE servers & gathering wait

Current ICE servers (`webrtc-types.ts:56-59`):

```typescript
export const ICE_SERVERS: RTCIceServer[] = [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
];
```

ICE gathering wait (`webrtc-connection.ts:293-306`):

```typescript
if (this.peerConnection.iceGatheringState !== 'complete') {
  await new Promise<void>((resolve) => {
    // ... waits for 'icegatheringstatechange' to 'complete'
  });
}
```

GA reference code (Azure sample, no ICE at all):

```javascript
let peerConnection = new RTCPeerConnection();
const offer = await peerConnection.createOffer();
await peerConnection.setLocalDescription(offer);
// IMMEDIATELY sends SDP -- no ICE gathering wait
const sdpResponse = await fetch(WEBRTC_URL, { ... body: offer.sdp ... });
```

### V-11: Sequential fetches

`session-config.ts:101-124`:

```typescript
// Sequential fetch 1
const memory = await fetchConversationMemory(maestro.id);
// Sequential fetch 2
const response = await fetch('/api/adaptive/context?...');
```

### V-06: Greeting flow

```
createActiveCharacter(character, type, profile)  <- NO language param
  -> helpers.ts:31 createActiveCharacterImpl(..., language = "it")  <- defaults "it"
    -> line 39: buddy.getGreeting({language})  <- buddies: OK (but always "it")
    -> line 44: coach.greeting  <- coaches: static Italian, NEVER calls getGreeting
    -> line 49: maestro.greeting  <- maestri: static Italian, NEVER calls getGreeting
```

### V-13: CORS fix

`src/lib/security/cors-config.ts:62` currently allows only `Content-Type, Authorization`.
`csrfFetch` sends `X-CSRF-Token` -> browser blocks preflight for cross-origin requests.

### V-14: Admin redirect fix

`src/proxy.ts:303`:

```typescript
const adminUrl = new URL(pathWithoutLocale, request.url);
// Missing: adminUrl.search = new URL(request.url).search;
```

### D-01: Conversation stores

| Store                      | File                                              | Consumers | Manages                                                                              |
| -------------------------- | ------------------------------------------------- | --------- | ------------------------------------------------------------------------------------ |
| `useConversationStore`     | `src/lib/stores/conversation-store.ts`            | 8 files   | `conversations[].messages`, `createConversation()`, `addMessage()`, `syncToServer()` |
| `useConversationFlowStore` | `src/lib/stores/conversation-flow-store/store.ts` | 10 files  | session lifecycle, messages via message-slice, character routing, handoff            |

`use-character-chat/index.ts` imports `useConversationStore` for persistence.
`conversation-flow.tsx` uses `useConversationFlowStore` for the flow.
Both write messages -> can diverge.

### D-03: Three chat components switching

Code path in `src/app/[locale]/page.tsx`:

```
currentView === 'maestro-session' -> <LazyMaestroSession .../>
currentView === 'coach'           -> <LazyCharacterChatView characterType="coach" />
currentView === 'buddy'           -> <LazyCharacterChatView characterType="buddy" />
```

### D-04: TTS in maestro bubble only

Maestro bubble (`src/components/maestros/message-bubble.tsx:71-74`):

```tsx
{
  !isUser && ttsEnabled && <button onClick={() => speak(message.content)}>speaker</button>;
}
```

This TTS functionality does NOT exist in `src/components/conversation/components/message-bubble.tsx`.

### D-05: Handoff absent from MaestroSession

```
grep -rn "handoff\|Handoff" src/components/maestros/
-> ZERO results
```

Handoff exists ONLY in `src/components/conversation/conversation-flow.tsx`.

### D-08: Four calculateLevel() with callers

| File                       | Imported by                            |
| -------------------------- | -------------------------------------- |
| `gamification-helpers.ts`  | `gamification/db.ts`                   |
| `method-progress-utils.ts` | `method-progress-handlers.ts`          |
| `utils.ts:37`              | Uses own version internally            |
| `xp-rewards.ts`            | No imports found (potential dead code) |

### D-11: Spinner pattern counts

```tsx
<Loader2 className="w-4 h-4 animate-spin" />     // ~100 files
<Loader2 className="w-8 h-8 animate-spin" />     // ~40 files
<Loader2 className="h-5 w-5 animate-spin" />     // ~30 files
<div className="border-2 ... animate-spin" />     // ~29 files (CSS spinner custom)
```

### D-14: Manual auth route sample

| Route                                       | Pattern                                  |
| ------------------------------------------- | ---------------------------------------- |
| `src/app/api/user/route.ts:20`              | `const auth = await validateAuth()`      |
| `src/app/api/tools/stream/route.ts:39`      | `const auth = await validateAuth()`      |
| `src/app/api/tools/sse/route.ts:39`         | `const auth = await validateAuth()`      |
| `src/app/api/chat/stream/helpers.ts:51`     | `const auth = await validateAuth()`      |
| `src/app/api/chat/auth-handler.ts:15`       | `const auth = await validateAuth()`      |
| `src/app/api/onboarding/handlers.ts:23,72`  | `const auth = await validateAuth()` (2x) |
| `src/app/api/trial/voice/route.ts:37,131`   | `const auth = await validateAuth()` (2x) |
| `src/app/api/trial/session/route.ts:67,158` | `const auth = await validateAuth()` (2x) |
| `src/app/api/scheduler/helpers.ts:11`       | `const auth = await validateAuth()`      |
| `src/app/api/telemetry/events/route.ts:55`  | `const auth = await validateAuth()`      |
| `src/app/api/safety/events/route.ts:28`     | `const auth = await validateAuth()`      |

### D-17: Error response format samples

```json
{ "error": "Forbidden" }                          // 12 routes
{ "error": "Material not found" }                  // 9 routes
{ "error": "message", "details": "..." }           // Some routes
{ "error": "message", "required": [...] }          // materials POST
{ "error": "message", "validation": [...] }        // Other routes
```

### D-19: Voice enabled differently per character type

`src/components/conversation/components/conversation-header.tsx:67-82`:

```tsx
{
  /* Voice call button - only for coach and buddy */
}
{
  (currentCharacter.type === 'coach' || currentCharacter.type === 'buddy') && (
    <Button onClick={onVoiceCall}>...</Button>
  );
}
```

Lines 91 and 101:

```tsx
disabled={currentCharacter.type === 'coach'}   // COACH: switch-to-coach disabled
disabled={currentCharacter.type === 'buddy'}   // BUDDY: switch-to-buddy disabled
```

MaestroSession has its own voice system with `CharacterVoicePanel` as sibling component.
Backend: ALL characters have `voice` and `voiceInstructions` fields in data definitions.

---

## APPENDIX J — TRANSCRIPT SAFETY NET CODE

### User transcript handler (event-handlers.ts)

```typescript
case 'conversation.item.input_audio_transcription.completed':
  if (event.transcript) {
    deps.addTranscript('user', event.transcript);

    // NEW: Safety check on user speech
    const filterResult = filterInput(event.transcript);
    if (filterResult.action === 'block') {
      // Cancel current response
      deps.dataChannel.send(JSON.stringify({
        type: 'response.cancel'
      }));
      // Redirect to safe response
      deps.dataChannel.send(JSON.stringify({
        type: 'conversation.item.create',
        item: {
          type: 'message',
          role: 'user',
          content: [{ type: 'input_text', text: filterResult.safeResponse }]
        }
      }));
      deps.dataChannel.send(JSON.stringify({ type: 'response.create' }));
    }
  }
```

### AI transcript handler (event-handlers.ts)

```typescript
case 'response.audio_transcript.done':
  if (event.transcript) {
    deps.addTranscript('assistant', event.transcript);

    // NEW: Post-hoc safety check on AI response
    const biasResult = detectBias(event.transcript);
    if (!biasResult.safeForEducation) {
      logSafetyEvent('bias_in_voice', { ... });
    }
    if (containsCrisisKeywords(event.transcript)) {
      logCrisisDetected({ ... });
    }
  }
```

**Limitation**: Reacts AFTER audio plays (~1-2s delay). Cannot prevent audio from being heard. But CAN:

- Log the violation for compliance
- Redirect the next AI response
- Terminate the session if critical
- Notify the parent dashboard

---

## APPENDIX K — GA SESSION CONFIG IN TOKEN REQUEST

GA token request body (sent to `/v1/realtime/client_secrets`):

```json
{
  "session": {
    "type": "realtime",
    "model": "<deployment>",
    "instructions": "You are a helpful assistant.",
    "audio": {
      "output": {
        "voice": "marin"
      }
    }
  }
}
```

This eliminates the `session.update` -> `session.updated` round-trip after connection.
The model is pre-configured when the token is issued.

**GA `session.update` changes** (if still used):

- Requires `type: "realtime"` field
- `"realtime"` for speech-to-speech
- `"transcription"` for realtime audio transcription

**OpenAI-Beta header**: GA does NOT require it. Verify MirrorBuddy does not send it.

---

## APPENDIX L — FRAMEWORK ARCHITECTURE DIAGRAM

```
+-------------------------------------------------------------+
|                    BACKEND (UNIFIED)                          |
|  One /api/chat, one character-router, one tool filtering,    |
|  same voice API for all character types                       |
+---------------------------+---------------------------------+
                            |
          +-----------------+-------------------+
          v                 v                   v
   +-------------+   +--------------+   +------------------+
   | MaestroSess |   | CharChatView |   | MatConversation  |
   | (271 lines) |   | (216 lines)  |   | (633 lines)      |
   |             |   |              |   |                  |
   | TTS: YES    |   | TTS: NO      |   | TTS: NO          |
   | Voice: YES  |   | Voice: YES   |   | Voice: NO        |
   | Handoff: NO |   | Handoff: YES |   | Handoff: NO      |
   | 5 Header    |   | 1 Header     |   | 1 Header         |
   | variants    |   |              |   |                  |
   +-------------+   +--------------+   +------------------+
     26 Maestri      6 Coach+6 Buddy    Education module
```

---

## APPENDIX M — VOICE-SPECIFIC RISK MITIGATIONS

| Risk                                       | Mitigation                                                                |
| ------------------------------------------ | ------------------------------------------------------------------------- |
| Large instructions may slow first response | Monitor via Sentry latency traces; fall back to current truncation if >3s |
| Transcript safety has ~1-2s delay          | Level 1 (instructions) prevents 95%; Level 2 is audit + redirect          |
| `injectSafetyGuardrails` has server deps   | Use `SAFETY_CORE_PROMPT` constant (pure text, no Prisma)                  |
| Greeting language detection wrong          | Use `useLocale()` hook — same as rest of UI                               |
| Token cache stale                          | 30s refresh buffer already built into `token-cache.ts`                    |

---

## APPENDIX N — CORRECTIONS TO PREVIOUS REPORTS

| Previous claim                        | Correction                                                                               |
| ------------------------------------- | ---------------------------------------------------------------------------------------- |
| "WebRTC endpoint uses preview domain" | CONFIRMED. GA moves to resource domain `/v1/realtime/calls`                              |
| "STUN servers are unnecessary"        | CONFIRMED by GA sample code (no ICE servers at all)                                      |
| "ICE gathering wait is unnecessary"   | CONFIRMED by GA sample code (sends offer immediately)                                    |
| "PCM16 format is a problem"           | CORRECTED. PCM16 config has no effect in WebRTC mode. Harmless but remove for clarity.   |
| "API version is obsolete (preview)"   | CONFIRMED. Preview deprecated 30 April 2026. GA uses `/openai/v1/` path, no api-version. |
| "Double fetch in SDP exchange"        | CONFIRMED. GA eliminates the need for separate token endpoint.                           |
| "Audio playback queue is dead code"   | CONFIRMED. WebRTC audio goes via `ontrack` -> `<Audio>` element. Queue/scheduler unused. |

---

## APPENDIX O — WORK ALREADY IN PROGRESS

Per git status at time of audit:

**Modified maestri files** (formal greeting updates, partially done):
`cassese.ts`, `cicerone.ts`, `curie.ts`, `darwin.ts`, `erodoto.ts`, `euclide.ts`,
`galileo.ts`, `humboldt.ts`, `ippocrate.ts`, `leonardo.ts`, `lovelace.ts`,
`manzoni.ts`, `mozart.ts`, `shakespeare.ts`, `smith.ts`, `socrate.ts`

**Modified voice files** (in progress):

- `src/lib/hooks/voice-session/session-config.ts`
- `src/lib/hooks/voice-session/voice-prompt-builder.ts`

**Modified CORS**:

- `src/lib/security/cors-config.ts`

**Untracked analysis docs** (this consolidation supersedes):

- `DUPLICATION-ANALYSIS.md`
- `Voice26.md`
- `mirrorbuddy-voice-architecture-audit-2026-02-14.md`

---

## APPENDIX P — GA WEBRTC FILTER & WEBSOCKET OBSERVER

### WebRTC Filter (`?webrtcfilter=on`)

GA adds `?webrtcfilter=on` query parameter to `/v1/realtime/calls`. When enabled,
limits data channel messages to the browser, keeping prompt instructions private.

**Allowed events with filter ON**:

- `input_audio_buffer.speech_started`
- `input_audio_buffer.speech_stopped`
- `output_audio_buffer.started`
- `output_audio_buffer.stopped`
- `conversation.item.input_audio_transcription.completed`
- `conversation.item.added`
- `conversation.item.created`
- `response.output_text.delta`
- `response.output_text.done`
- `response.output_audio_transcript.delta`
- `response.output_audio_transcript.done`

**Impact for MirrorBuddy**: Tool calls and tool results go via data channel.
With `webrtcfilter=on`, tool-related events would be BLOCKED.
Do NOT enable unless tool handling moves server-side.

### WebSocket Observer

GA allows creating a WebSocket sideband connection to observe/control a WebRTC call.
When the SDP exchange returns HTTP 201, the `Location` header contains a call ID.

A server can connect via WebSocket to:

```
wss://{resource}.openai.azure.com/openai/v1/realtime?call_id={call_id}
```

Enables:

- Session recording for compliance
- Real-time monitoring dashboard
- Server-side tool execution

Evaluate post-migration for Italian L.132/2025 compliance recording.
