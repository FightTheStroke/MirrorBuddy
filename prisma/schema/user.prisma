// ============================================================================
// USER & PROFILE DOMAIN
// Core user identity, settings, and accessibility preferences
// ============================================================================

// F-26: Role-based access control
enum UserRole {
  USER
  ADMIN
}

model User {
  id        String   @id @default(cuid())
  role      UserRole @default(USER) // F-26: Admin role for admin endpoints
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Plan 052: Internal auth (username/password)
  username           String? @unique // null for legacy/cookie-only users
  email              String? @unique // for password reset notifications
  emailHash          String? // deterministic hash for encrypted email lookups
  passwordHash       String? // bcrypt hash, null for legacy users
  mustChangePassword Boolean @default(false)
  disabled           Boolean @default(false)

  // F-17: Test data isolation
  isTestData Boolean @default(false)

  // F-02: User-selected maestri persistence
  selectedMaestri String[] @default([])

  profile           Profile?
  settings          Settings?
  progress          Progress?
  sessions          StudySession[]
  flashcards        FlashcardProgress[]
  quizResults       QuizResult[]
  conversations     Conversation[]
  learnings         Learning[]
  pushSubscriptions PushSubscription[]

  // Issue #64: Consolidated localStorage data
  accessibility    AccessibilitySettings?
  onboarding       OnboardingState?
  pomodoroStats    PomodoroStats?
  calendarEvents   CalendarEvent[]
  htmlSnippets     HtmlSnippet[]
  homeworkSessions HomeworkSession[]
  gamification     UserGamification?

  // Knowledge Graph (Wave 3)
  concepts Concept[]

  // Content Domain - Materials, Collections, Tags
  materials         Material[]
  collections       Collection[]
  tags              Tag[]
  studyKits         StudyKit[]
  contentEmbeddings ContentEmbedding[]

  // Learning Path Domain
  learningPaths LearningPath[]
  topicAttempts TopicAttempt[]

  // Scheduling Domain
  notifications     Notification[]
  studySchedules    StudySchedule[]
  scheduledSessions ScheduledSession[]
  customReminders   CustomReminder[]

  // Insights Domain
  parentNotes ParentNote[]

  // Education Domain (additional)
  sessionMetrics SessionMetrics[]
  methodProgress MethodProgress?

  // Google Drive Integration (ADR 0038)
  googleAccount GoogleAccount?

  // Privacy & Data Retention (F-02)
  privacyPreferences UserPrivacyPreferences?

  // COPPA Compliance (F-09)
  coppaConsent CoppaConsent?

  // Terms of Service (F-13)
  tosAcceptances TosAcceptance[]

  // Compliance & Audit (F-08)
  auditEntriesAsSubject ComplianceAuditEntry[]
  auditEntriesAsAdmin   ComplianceAuditEntry[] @relation("AdminAuditLog")

  // Tier Subscription System (ADR 0071)
  subscription UserSubscription?

  // User-level feature AI config overrides (ADR 0073)
  featureConfigs UserFeatureConfig[] @relation("UserFeatureConfigs")

  // Dependency Monitoring (Amodei 2026)
  usagePatterns    UsagePattern[]
  dependencyAlerts DependencyAlert[]

  // Video Vision Usage Tracking (ADR 0122)
  videoVisionUsages VideoVisionUsage[] @relation("VideoVisionUsages")

  // Password Reset Tokens (Plan 125)
  passwordResetTokens PasswordResetToken[]

  @@index([emailHash])
}

model Profile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String?
  age           Int?
  schoolYear    Int?
  schoolLevel   String  @default("superiore")
  gradeLevel    String?
  learningGoals String  @default("[]")

  // Character preferences (coach and buddy selection)
  preferredCoach String? // melissa, roberto, chiara, andrea, favij
  preferredBuddy String? // mario, noemi, enea, bruno, sofia

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Settings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Appearance
  theme       String @default("system")
  language    String @default("it")
  accentColor String @default("blue")

  // Accessibility
  fontSize           String  @default("medium")
  highContrast       Boolean @default(false)
  dyslexiaFont       Boolean @default(false)
  reducedMotion      Boolean @default(false)
  voiceEnabled       Boolean @default(true)
  simplifiedLanguage Boolean @default(false)
  adhdMode           Boolean @default(false)

  // AI Provider
  provider               String @default("azure")
  model                  String @default("gpt-5-mini")
  budgetLimit            Float  @default(50.0)
  totalSpent             Float  @default(0.0)
  adaptiveDifficultyMode String @default("balanced")

  // Parent Mode Consent (Issue #63)
  parentChatConsentAt DateTime?

  // Parent Dashboard (Issue #64)
  parentDashboardLastViewed DateTime?

  // Azure Cost Configuration
  azureCostConfig String? // JSON: {token_cost, audio_cost, etc.}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GoogleAccount {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Google profile info
  googleId    String  @unique
  email       String
  emailHash   String? // deterministic hash for encrypted email lookups
  displayName String?
  avatarUrl   String?

  // OAuth tokens (encrypted at rest via application layer)
  accessToken  String
  refreshToken String?
  tokenType    String   @default("Bearer")
  expiresAt    DateTime

  // Scopes granted by user
  scopes String @default("[]")

  // Connection status
  isConnected Boolean  @default(true)
  lastUsedAt  DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([googleId])
  @@index([emailHash])
}

model AccessibilitySettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dyslexia support
  dyslexiaFont        Boolean @default(false)
  extraLetterSpacing  Boolean @default(false)
  increasedLineHeight Boolean @default(false)

  // Visual support
  highContrast  Boolean @default(false)
  largeText     Boolean @default(false)
  reducedMotion Boolean @default(false)

  // Text-to-Speech
  ttsEnabled  Boolean @default(false)
  ttsSpeed    Float   @default(1.0)
  ttsAutoRead Boolean @default(false)

  // ADHD support
  adhdMode            Boolean @default(false)
  distractionFreeMode Boolean @default(false)
  breakReminders      Boolean @default(false)

  // General accessibility
  lineSpacing        Float   @default(1.0)
  fontSize           Float   @default(1.0)
  colorBlindMode     Boolean @default(false)
  keyboardNavigation Boolean @default(true)

  // Voice accessibility (ADR-0069)
  adaptiveVadEnabled Boolean @default(true)

  // Custom colors
  customBackgroundColor String @default("#ffffff")
  customTextColor       String @default("#000000")

  // ADHD Session Config (JSON)
  adhdConfig String @default("{}")
  adhdStats  String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model OnboardingState {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Flow state
  hasCompletedOnboarding Boolean   @default(false)
  onboardingCompletedAt  DateTime?
  currentStep            String    @default("welcome")
  isReplayMode           Boolean   @default(false)
  isVoiceMuted           Boolean   @default(false)

  // Collected data (JSON)
  data String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model PomodoroStats {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Persistent stats
  completedPomodoros Int    @default(0)
  totalFocusTime     Int    @default(0)
  todayPomodoros     Int    @default(0)
  todayFocusMinutes  Int    @default(0)
  lastActiveDate     String @default("")

  // Settings (JSON)
  settings String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}
