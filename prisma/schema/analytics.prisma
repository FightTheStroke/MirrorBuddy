// ============================================================================
// ANALYTICS DOMAIN
// Telemetry, rate limiting, and safety events
// ============================================================================

model TelemetryEvent {
  id      String @id @default(cuid())
  eventId String @unique

  // Event data
  timestamp DateTime
  category  String
  action    String
  label     String?
  value     Float?
  metadata  String?

  // Session & user tracking
  sessionId String
  userId    String?

  // F-06: Test data isolation
  isTestData Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
  @@index([category])
  @@index([action])
  @@index([userId, timestamp])
}

model RateLimitEvent {
  id        String   @id @default(cuid())
  userId    String?
  endpoint  String
  limit     Int
  window    Int
  ipAddress String?
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([endpoint, timestamp])
  @@index([timestamp])
}

model SafetyEvent {
  id             String    @id @default(cuid())
  userId         String?
  type           String
  severity       String
  conversationId String?
  resolvedBy     String?
  resolvedAt     DateTime?
  resolution     String?
  timestamp      DateTime  @default(now())

  @@index([userId, timestamp])
  @@index([severity, timestamp])
  @@index([timestamp])
}

// ============================================================================
// FEATURE FLAGS - Persistent feature flag state for production reliability
// ============================================================================

model FeatureFlag {
  id                String   @id // e.g., "voice_realtime", "rag_enabled"
  name              String
  description       String
  status            String   @default("enabled") // enabled | disabled | degraded
  enabledPercentage Int      @default(100) // 0-100 for gradual rollout
  killSwitch        Boolean  @default(false)
  killSwitchReason  String?
  metadata          Json?
  updatedAt         DateTime @updatedAt
  updatedBy         String?

  @@index([status])
  @@index([killSwitch])
}

model GlobalConfig {
  id               String   @id @default("global")
  killSwitch       Boolean  @default(false)
  killSwitchReason String?
  updatedAt        DateTime @updatedAt
  updatedBy        String?
}

// ============================================================================
// REAL-TIME USER ACTIVITY - Tracks active users for serverless-safe metrics
// Records are cleaned up after 10 minutes by the metrics-push cron job
// ============================================================================

model UserActivity {
  id         String   @id @default(cuid())
  identifier String // User ID or visitor ID
  userType   String // "logged" | "trial" | "anonymous"
  route      String // Normalized route path
  timestamp  DateTime @default(now())

  // F-06: Test data isolation (ADR 0065)
  isTestData Boolean @default(false)

  @@index([timestamp])
  @@index([userType, timestamp])
  @@index([identifier, timestamp])
  @@index([isTestData, timestamp])
}

// ============================================================================
// FUNNEL EVENT TRACKING - Tracks user journey through conversion funnel
// Separate from TelemetryEvent for clean funnel queries (Plan 069)
// ============================================================================

model FunnelEvent {
  id String @id @default(cuid())

  // User identification (one of these required)
  visitorId String? // For trial users (before signup)
  userId    String? // For authenticated users

  // Funnel data
  stage     String // VISITOR | TRIAL_START | TRIAL_ENGAGED | LIMIT_HIT | BETA_REQUEST | APPROVED | FIRST_LOGIN | ACTIVE | CHURNED
  fromStage String? // Previous stage (null for first event)
  locale    String? // ISO 639-1 locale code (e.g., "it", "en", "fr", "de", "es")

  // Context
  metadata Json? // Extra data (e.g., maestro used, feature triggered)

  // Timestamps
  createdAt DateTime @default(now())

  // F-06: Test data isolation
  isTestData Boolean @default(false)

  @@index([visitorId, createdAt])
  @@index([userId, createdAt])
  @@index([stage, createdAt])
  @@index([locale, createdAt])
  @@index([isTestData, createdAt])
}

// ============================================================================
// ADMIN AUDIT LOG - Tracks all admin actions for accountability (F-33)
// Separate from ComplianceAuditEntry (regulatory) - this is internal admin tracking
// ============================================================================

model AdminAuditLog {
  id String @id @default(cuid())

  // Action classification
  action     String // e.g., "user_created", "user_deleted", "tier_changed", "invite_approved"
  entityType String // e.g., "User", "Invite", "TierDefinition", "FeatureFlag"
  entityId   String // ID of the affected entity

  // Admin who performed the action
  adminId String

  // Additional context
  details   Json?   // JSON-serialized additional data (old/new values, etc.)
  ipAddress String? // IP address of the admin

  // Timestamps
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([adminId])
  @@index([createdAt])
  @@index([adminId, createdAt])
  @@index([entityType, entityId])
}
