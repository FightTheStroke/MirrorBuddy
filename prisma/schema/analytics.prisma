// ============================================================================
// ANALYTICS DOMAIN
// Telemetry, rate limiting, and safety events
// ============================================================================

model TelemetryEvent {
  id      String @id @default(cuid())
  eventId String @unique

  // Event data
  timestamp DateTime
  category  String
  action    String
  label     String?
  value     Float?
  metadata  String?

  // Session & user tracking
  sessionId String
  userId    String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
  @@index([category])
  @@index([action])
  @@index([userId, timestamp])
}

model RateLimitEvent {
  id        String   @id @default(cuid())
  userId    String?
  endpoint  String
  limit     Int
  window    Int
  ipAddress String?
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([endpoint, timestamp])
  @@index([timestamp])
}

model SafetyEvent {
  id             String    @id @default(cuid())
  userId         String?
  type           String
  severity       String
  conversationId String?
  resolvedBy     String?
  resolvedAt     DateTime?
  resolution     String?
  timestamp      DateTime  @default(now())

  @@index([userId, timestamp])
  @@index([severity, timestamp])
  @@index([timestamp])
}

// ============================================================================
// FEATURE FLAGS - Persistent feature flag state for production reliability
// ============================================================================

model FeatureFlag {
  id                String   @id // e.g., "voice_realtime", "rag_enabled"
  name              String
  description       String
  status            String   @default("enabled") // enabled | disabled | degraded
  enabledPercentage Int      @default(100) // 0-100 for gradual rollout
  killSwitch        Boolean  @default(false)
  killSwitchReason  String?
  metadata          Json?
  updatedAt         DateTime @updatedAt
  updatedBy         String?

  @@index([status])
  @@index([killSwitch])
}

model GlobalConfig {
  id        String   @id @default("global")
  killSwitch Boolean @default(false)
  killSwitchReason String?
  updatedAt DateTime @updatedAt
  updatedBy String?
}

