// ============================================================================
// EDUCATION DOMAIN
// Flashcards, quizzes, learning progress, and study sessions
// ============================================================================

model FlashcardProgress {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  cardId String
  deckId String?

  // FSRS Algorithm State
  difficulty     Float  @default(0.0)
  stability      Float  @default(0.0)
  retrievability Float  @default(1.0)
  state          String @default("new")

  // Review tracking
  reps       Int       @default(0)
  lapses     Int       @default(0)
  lastReview DateTime?
  nextReview DateTime?

  // F-06: Test data isolation
  isTestData Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, cardId])
  @@index([userId])
  @@index([nextReview])
  @@index([userId, nextReview])
  @@index([userId, deckId])
}

model QuizResult {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  quizId         String
  subject        String?
  topic          String?
  score          Int
  totalQuestions Int
  percentage     Float
  avgDifficulty  Float?
  source         String?

  // Detailed answers as JSON
  answers String @default("[]")

  // F-06: Test data isolation
  isTestData Boolean @default(false)

  completedAt DateTime @default(now())

  @@index([userId])
  @@index([completedAt])
}

model Learning {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Context
  maestroId String?
  subject   String?

  // The learning itself
  category String
  insight  String

  // Confidence tracking
  confidence  Float @default(0.5)
  occurrences Int   @default(1)

  // Timestamps
  createdAt DateTime @default(now())
  lastSeen  DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@index([confidence])
  @@index([userId, category])
}

model StudySession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  maestroId String
  subject   String
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int?
  xpEarned  Int       @default(0)
  questions Int       @default(0)

  // Student self-evaluation (1-5 stars)
  studentRating   Int?
  studentFeedback String?

  // AI Maestro evaluation (1-10 score)
  maestroScore    Int?
  maestroFeedback String?
  strengths       String?
  areasToImprove  String?

  // Session context
  topics         String  @default("[]")
  conversationId String?

  // Tools created during session
  materials Material[]

  // F-06: Test data isolation
  isTestData Boolean @default(false)

  @@index([userId])
  @@index([maestroId])
  @@index([startedAt])
  @@index([conversationId])
}

model SessionMetrics {
  id        String @id @default(cuid())
  sessionId String @unique
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session outcome (V1Plan FASE 2 definitions)
  outcome String @default("unknown") // success | dropped | stuck_loop | abandoned

  // Behavioral metrics
  turnCount        Int   @default(0)
  avgTurnLatencyMs Int?
  stuckLoopCount   Int   @default(0) // Same intent repeated 3+ times in 5 turns

  // Cost tracking (V1Plan FASE 6)
  tokensIn     Int   @default(0)
  tokensOut    Int   @default(0)
  voiceMinutes Float @default(0)
  costEur      Float @default(0)

  // Safety events
  refusalCount      Int     @default(0)
  refusalCorrect    Int     @default(0)
  incidentSeverity  String? // S0 | S1 | S2 | S3 (highest in session)
  jailbreakAttempts Int     @default(0)

  // F-17: Test data isolation
  isTestData Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([outcome])
  @@index([createdAt])
  @@index([incidentSeverity])
  @@map("session_metrics")
}

model MethodProgress {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Skill progress (JSON stored)
  mindMaps       String @default("{}")
  flashcards     String @default("{}")
  selfAssessment String @default("{}")
  helpBehavior   String @default("{}")
  methodTransfer String @default("{}")

  // Events history (JSON array)
  events String @default("[]")

  // Computed scores
  autonomyScore Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([autonomyScore])
}
