// ============================================================================
// PRIVACY & DATA RETENTION DOMAIN
// User privacy preferences, consent tracking, and data retention policies
// ============================================================================

// COPPA Compliance (16 CFR Part 312)
// Tracks parental consent for users under 13
model CoppaConsent {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // User's age at time of consent request
  ageAtConsent Int

  // Consent status
  parentEmail           String? // Parent's email for verification
  verificationCode      String? // One-time verification code
  verificationSentAt    DateTime?
  verificationExpiresAt DateTime?
  consentGranted        Boolean   @default(false)
  consentGrantedAt      DateTime?
  consentDeniedAt       DateTime?

  // Audit trail
  parentIpAddress String? // IP of parent when granting consent
  verificationMethod String @default("email") // email, in_person, phone

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([parentEmail])
  @@index([verificationCode])
}

model UserPrivacyPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Opt-in to pseudonymized learning mode
  pseudonymizedMode Boolean @default(false)

  /// Custom retention policy overrides (JSON: Partial<DataRetentionPolicy>)
  /// Structure: { conversationTTLDays?, embeddingsTTLDays?, progressTTLDays?, flashcardTTLDays?, autoDelete? }
  customRetention String?

  /// Consent timestamp for privacy preferences
  consentedAt DateTime @default(now())

  /// Last updated timestamp
  updatedAt DateTime @updatedAt

  createdAt DateTime @default(now())

  @@index([userId])
}

// F-13: Terms of Service Acceptance Tracking
// Tracks user acceptance of ToS with versioning and audit trail
model TosAcceptance {
  id        String   @id @default(cuid())
  userId    String
  version   String   // e.g., "1.0", "1.1", "2.0"
  acceptedAt DateTime @default(now())

  // Audit trail for compliance
  ipAddress String?  // Last IP segment only for privacy
  userAgent String?  // Browser/client info

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ensure one record per user per version
  @@unique([userId, version])
  @@index([userId])
  @@index([version])
  @@map("tos_acceptances")
}
