// ============================================================================
// RAG & KNOWLEDGE GRAPH DOMAIN
// Vector embeddings for semantic search and material relationships
// ============================================================================

model ContentEmbedding {
  id          String   @id @default(cuid())
  userId      String

  // Source content reference
  sourceType  String
  sourceId    String
  chunkIndex  Int      @default(0)

  // The actual text that was embedded
  content     String

  // Vector embedding - dual storage for migration
  vector       String?
  vectorNative Unsupported("vector(1536)")?

  // Embedding metadata
  model       String   @default("text-embedding-3-small")
  dimensions  Int      @default(1536)
  tokenCount  Int      @default(0)

  // Search optimization
  subject     String?
  tags        String   @default("[]")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([sourceType, sourceId, chunkIndex])
  @@index([userId])
  @@index([sourceType])
  @@index([sourceId])
  @@index([subject])
  @@index([createdAt])
}

// Edges between materials
model MaterialEdge {
  id           String   @id @default(cuid())
  fromId       String
  toId         String
  relationType String
  weight       Float    @default(1.0)
  metadata     Json?
  createdAt    DateTime @default(now())

  from         Material @relation("MaterialEdgeFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to           Material @relation("MaterialEdgeTo", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId, relationType])
  @@index([fromId])
  @@index([toId])
  @@index([relationType])
}

// Abstract concepts for semantic organization
model Concept {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  subject     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  materials   MaterialConcept[]

  @@unique([userId, name])
  @@index([userId])
  @@index([subject])
}

// Junction table: Material <-> Concept
model MaterialConcept {
  materialId String
  conceptId  String
  relevance  Float    @default(1.0)
  createdAt  DateTime @default(now())

  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  concept    Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)

  @@id([materialId, conceptId])
  @@index([materialId])
  @@index([conceptId])
}
