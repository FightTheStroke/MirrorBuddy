// ============================================================================
// MIRRORBUDDY WEB - DATABASE SCHEMA
// PostgreSQL with pgvector for semantic search
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  engineType      = "binary"
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector")]
}

// ============================================================================
// USER & PROFILE
// ============================================================================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile       Profile?
  settings      Settings?
  progress      Progress?
  sessions          StudySession[]
  flashcards        FlashcardProgress[]
  quizResults       QuizResult[]
  conversations     Conversation[]
  learnings         Learning[]
  pushSubscriptions PushSubscription[]

  // Issue #64: Consolidated localStorage data
  accessibility     AccessibilitySettings?
  onboarding        OnboardingState?
  pomodoroStats     PomodoroStats?
  calendarEvents    CalendarEvent[]
  htmlSnippets      HtmlSnippet[]
  homeworkSessions  HomeworkSession[]
  gamification      UserGamification?

  // Knowledge Graph (Wave 3)
  concepts          Concept[]

  // Google Drive Integration (ADR 0038)
  googleAccount     GoogleAccount?
}

model Profile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String?
  age           Int?
  schoolYear    Int?
  schoolLevel   String   @default("superiore")
  gradeLevel    String?
  learningGoals String   @default("[]")

  // Character preferences (coach and buddy selection)
  preferredCoach String?  // melissa, roberto, chiara, andrea, favij
  preferredBuddy String?  // mario, noemi, enea, bruno, sofia

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================================================
// SETTINGS
// ============================================================================

model Settings {
  id            String  @id @default(cuid())
  userId        String  @unique
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Appearance
  theme         String  @default("system")
  language      String  @default("it")
  accentColor   String  @default("blue")

  // Accessibility
  fontSize           String  @default("medium")
  highContrast       Boolean @default(false)
  dyslexiaFont       Boolean @default(false)
  reducedMotion      Boolean @default(false)
  voiceEnabled       Boolean @default(true)
  simplifiedLanguage Boolean @default(false)
  adhdMode           Boolean @default(false)

  // AI Provider
  provider      String  @default("azure")
  model         String  @default("gpt-4o")
  budgetLimit   Float   @default(50.0)
  totalSpent    Float   @default(0.0)
  adaptiveDifficultyMode String @default("balanced")

  // Parent Mode Consent (Issue #63)
  parentChatConsentAt DateTime?  // When parent consented to chat with professors

  // Parent Dashboard (Issue #64)
  parentDashboardLastViewed DateTime?  // When parent last viewed the dashboard

  // Azure Cost Configuration
  azureCostConfig String?  // JSON: {token_cost, audio_cost, etc.}

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================================================
// GOOGLE ACCOUNT (OAuth + Google Drive Integration - ADR 0038)
// ============================================================================

model GoogleAccount {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Google profile info
  googleId     String   @unique  // Google's user ID
  email        String
  displayName  String?
  avatarUrl    String?

  // OAuth tokens (encrypted at rest via application layer)
  accessToken  String   // Current access token
  refreshToken String?  // For token refresh (long-lived)
  tokenType    String   @default("Bearer")
  expiresAt    DateTime // When access token expires

  // Scopes granted by user
  scopes       String   @default("[]") // JSON array of granted scopes

  // Connection status
  isConnected  Boolean  @default(true)
  lastUsedAt   DateTime @default(now())

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([googleId])
}

// ============================================================================
// PROGRESS & GAMIFICATION
// ============================================================================

model Progress {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // MirrorBucks system (xp is backward compatibility)
  xp                Int       @default(0)
  level             Int       @default(1)

  // Season system
  seasonMirrorBucks Int       @default(0)
  seasonLevel       Int       @default(1)
  allTimeLevel      Int       @default(1)
  currentSeason     String?   // JSON: Season object
  seasonHistory     String    @default("[]") // JSON: SeasonHistory[]

  // Streak
  streakCurrent     Int       @default(0)
  streakLongest     Int       @default(0)
  lastStudyDate     DateTime?

  // Aggregates
  totalStudyMinutes Int       @default(0)
  questionsAsked    Int       @default(0)
  sessionsThisWeek  Int       @default(0)

  // Complex data as JSON
  achievements      String    @default("[]")
  masteries         String    @default("[]")
  adaptiveProfile   String    @default("{}")

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model StudySession {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  maestroId   String
  subject     String
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  duration    Int?
  xpEarned    Int       @default(0)
  questions   Int       @default(0)

  // Student self-evaluation (1-5 stars)
  studentRating    Int?
  studentFeedback  String?

  // AI Maestro evaluation (1-10 score)
  maestroScore     Int?
  maestroFeedback  String?
  strengths        String?   // JSON array
  areasToImprove   String?   // JSON array

  // Session context
  topics           String    @default("[]") // JSON array of topics covered
  conversationId   String?   // Link to Conversation

  // Tools created during session
  materials        Material[]

  @@index([userId])
  @@index([maestroId])
  @@index([startedAt])
  @@index([conversationId])
}

// ============================================================================
// EDUCATION: FLASHCARDS & QUIZZES
// ============================================================================

model FlashcardProgress {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  cardId         String
  deckId         String?

  // FSRS Algorithm State
  difficulty     Float     @default(0.0)
  stability      Float     @default(0.0)
  retrievability Float     @default(1.0)
  state          String    @default("new")

  // Review tracking
  reps           Int       @default(0)
  lapses         Int       @default(0)
  lastReview     DateTime?
  nextReview     DateTime?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId, cardId])
  @@index([userId])
  @@index([nextReview])
  @@index([userId, nextReview]) // Composite: "cards due for user" queries
}

model QuizResult {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  quizId         String
  subject        String?
  topic          String?
  score          Int
  totalQuestions Int
  percentage     Float
  avgDifficulty  Float?
  source         String?

  // Detailed answers as JSON
  answers        String   @default("[]")

  completedAt    DateTime @default(now())

  @@index([userId])
  @@index([completedAt])
}

// ============================================================================
// CONVERSATIONS & MEMORY
// ============================================================================

model Conversation {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  maestroId    String
  title        String?

  // Summary system
  summary      String?
  keyFacts     String?
  topics       String    @default("[]")

  // Message management
  messageCount Int       @default(0)
  messages     Message[]
  toolOutputs  ToolOutput[]

  // Status
  isActive     Boolean   @default(true)
  lastMessageAt DateTime?

  // Parent Mode (Issue #63)
  isParentMode Boolean   @default(false)
  studentId    String?   // The student being discussed (for parent conversations)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([maestroId])
  @@index([updatedAt])
  @@index([isParentMode])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role           String
  content        String

  // Optional metadata
  toolCalls      String?
  tokenCount     Int?

  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// ============================================================================
// TOOL OUTPUTS (Plan 44 - Tool Alignment with Maestri)
// Stores tool execution outputs linked to conversations for retrieval
// F-03, F-04: Conversation considers contenuti generati/caricati
// ============================================================================

model ToolOutput {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  toolType       String       // mindmap, quiz, flashcard, demo, etc.
  toolId         String?      // Reference to Material if persisted
  data           String       // JSON string of tool output data

  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([toolType])
  @@index([createdAt])
}

// ============================================================================
// LEARNINGS (Cross-session insights)
// ============================================================================

model Learning {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Context
  maestroId   String?
  subject     String?

  // The learning itself
  category    String
  insight     String

  // Confidence tracking
  confidence  Float    @default(0.5)
  occurrences Int      @default(1)

  // Timestamps
  createdAt   DateTime @default(now())
  lastSeen    DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@index([confidence])
}

// ============================================================================
// STUDENT INSIGHT PROFILES (Multi-Maestro Learning Insights for Parents)
// Related: Issue #31
// ============================================================================

model StudentInsightProfile {
  id           String    @id @default(cuid())
  userId       String    @unique
  studentName  String

  // Access control (GDPR)
  visibleTo    String    @default("parents") // parents | teachers | both

  // Consent tracking
  parentConsent   Boolean  @default(false)
  studentConsent  Boolean  @default(false)
  consentDate     DateTime?
  deletionRequested DateTime?

  // Synthesized profile data as JSON
  insights     String    @default("[]") // MaestroInsight[]
  strengths    String    @default("[]") // StrengthArea[]
  growthAreas  String    @default("[]") // GrowthArea[]
  learningStyle String   @default("{}") // LearningStyle
  strategies   String    @default("[]") // Strategy[]

  // Historical snapshots
  progressHistory String  @default("[]") // ProfileSnapshot[]

  // Metadata
  sessionCount  Int       @default(0)
  lastSessionId String?
  confidenceScore Float   @default(0.0)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Access log for GDPR audit
  accessLogs   ProfileAccessLog[]

  @@index([userId])
}

model ProfileAccessLog {
  id         String   @id @default(cuid())
  profileId  String
  profile    StudentInsightProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  userId     String
  action     String   // view | download | share | edit | delete_request
  details    String?
  ipAddress  String?
  userAgent  String?

  timestamp  DateTime @default(now())

  @@index([profileId])
  @@index([timestamp])
}

// ============================================================================
// NOTIFICATIONS (Server-side persistence for cross-device sync)
// ============================================================================

model Notification {
  id          String   @id @default(cuid())
  userId      String

  type        String   // achievement | streak | reminder | break | session_end | level_up | calendar | system | flashcard_due | scheduled_session | suggestion
  title       String
  message     String
  actionUrl   String?
  metadata    String?  // JSON for additional data

  // Scheduler-specific fields (Issue #27)
  priority     String?  // high | medium | low
  relatedId    String?  // Reference to flashcard deck, session, etc.
  melissaVoice String?  // Voice script for Melissa TTS

  read        Boolean  @default(false)
  dismissed   Boolean  @default(false)

  // Scheduling for future notifications
  scheduledFor DateTime?
  sentAt       DateTime?

  createdAt   DateTime @default(now())
  expiresAt   DateTime? // Auto-delete after expiry

  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([read])
  @@index([createdAt])
  @@index([scheduledFor])
}

// ============================================================================
// TELEMETRY (Usage Analytics & Grafana Integration)
// ============================================================================

model TelemetryEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique // Client-generated event ID for deduplication

  // Event data
  timestamp   DateTime
  category    String   // navigation | education | conversation | maestro | tools | accessibility | error | performance
  action      String   // Specific action (page_view, quiz_started, etc.)
  label       String?  // Additional context (page name, maestro ID, etc.)
  value       Float?   // Numeric value (duration, count, etc.)
  metadata    String?  // JSON for additional key-value pairs

  // Session & user tracking
  sessionId   String
  userId      String?  // Optional, only if authenticated

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
  @@index([category])
  @@index([action])
  @@index([userId, timestamp]) // Composite: "user analytics in time range" queries
}

// ============================================================================
// METHOD PROGRESS (Autonomy Tracking - Issue #28)
// ============================================================================

model MethodProgress {
  id        String @id @default(cuid())
  userId    String @unique

  // Skill progress (JSON stored)
  mindMaps       String @default("{}") // MindMapProgress JSON
  flashcards     String @default("{}") // FlashcardProgress JSON
  selfAssessment String @default("{}") // SelfAssessmentProgress JSON
  helpBehavior   String @default("{}") // HelpBehavior JSON
  methodTransfer String @default("{}") // MethodTransfer JSON

  // Events history (JSON array)
  events String @default("[]") // MethodEvent[] JSON

  // Computed scores
  autonomyScore Float @default(0) // 0-1

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([autonomyScore])
}

// ============================================================================
// MATERIALS (Persisted tool outputs - T-20)
// ============================================================================

model Material {
  id          String   @id @default(cuid())
  userId      String
  toolId      String   @unique // Client-generated tool ID
  toolType    String   // mindmap, quiz, flashcard, demo, etc.
  title       String
  content     String   // JSON string

  // Context
  maestroId   String?
  sessionId   String?
  session     StudySession? @relation(fields: [sessionId], references: [id])
  subject     String?
  preview     String?  // Preview text for lists

  // Message reference (optional FK to Message that created this material)
  messageId   String?

  // Migrated from CreatedTool
  topic          String?
  conversationId String?

  // Status
  status      String   @default("active") // active, archived, deleted

  // User interaction (Issue #37 - Archive features)
  userRating   Int?     // 1-5 stars
  isBookmarked Boolean  @default(false)
  viewCount    Int      @default(0)

  // Full-text search (ADR 0022 - Knowledge Hub, Issue #19)
  // PostgreSQL: Uses tsvector column (searchableTextVector) with GIN index for fast full-text search
  //             Queries use websearch_to_tsquery() with ts_rank() for relevance sorting
  //             Migration: prisma/migrations/fulltext/001_enable_fulltext_search.sql
  // SQLite:     Falls back to ILIKE '%query%' pattern matching (slower but compatible)
  // See: src/lib/db/database-utils.ts for database detection
  searchableText String?  // Pre-computed searchable content (title + preview + subject + tags)

  // Organization (ADR 0022 - Knowledge Hub)
  collectionId String?
  collection   Collection? @relation(fields: [collectionId], references: [id])
  tags         MaterialTag[]

  // Study Kit integration (links back to originating Study Kit)
  sourceStudyKitId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([toolType])
  @@index([status])
  @@index([sessionId])
  @@index([messageId])
  @@index([createdAt])
  @@index([isBookmarked])
  @@index([collectionId])
  @@index([sourceStudyKitId])
  @@index([userId, status]) // Composite: "active materials for user" queries

  // Knowledge Graph (Wave 3)
  edgesFrom        MaterialEdge[]    @relation("MaterialEdgeFrom")
  edgesTo          MaterialEdge[]    @relation("MaterialEdgeTo")
  concepts         MaterialConcept[]
}

// ============================================================================
// COLLECTIONS (ADR 0022 - Knowledge Hub)
// Folders for organizing materials
// ============================================================================

model Collection {
  id          String       @id @default(cuid())
  userId      String
  name        String
  description String?
  color       String?      // Hex color for folder icon
  icon        String?      // Optional icon name
  parentId    String?      // Nested folders support
  parent      Collection?  @relation("CollectionTree", fields: [parentId], references: [id])
  children    Collection[] @relation("CollectionTree")
  materials   Material[]
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([userId, name, parentId])
  @@index([userId])
  @@index([parentId])
}

// ============================================================================
// TAGS (ADR 0022 - Knowledge Hub)
// User-defined tags for materials
// ============================================================================

model Tag {
  id        String        @id @default(cuid())
  userId    String
  name      String
  color     String?       // Hex color for tag badge
  materials MaterialTag[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model MaterialTag {
  id         String   @id @default(cuid())
  materialId String
  tagId      String
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([materialId, tagId])
  @@index([materialId])
  @@index([tagId])
}

// ============================================================================
// PARENT NOTES (Auto-generated session summaries for parents)
// ============================================================================

model ParentNote {
  id          String    @id @default(cuid())
  userId      String
  sessionId   String
  maestroId   String
  subject     String
  duration    Int       // minutes

  // Content
  summary     String    // Brief summary for parents
  highlights  String    // JSON array of achievements
  concerns    String?   // JSON array of concerns (can be empty)
  suggestions String?   // JSON array of suggestions

  // Timestamps
  generatedAt DateTime  @default(now())
  viewedAt    DateTime?

  @@index([userId])
  @@index([sessionId])
  @@index([generatedAt])
}

// ============================================================================
// CREATED TOOLS (Maestro-generated interactive tools - Issue #39, #37)
// DEPRECATED: Use Material table instead. Kept for migration buffer.
// ============================================================================

model CreatedTool {
  id             String   @id @default(cuid())
  userId         String

  // Tool metadata
  type           String   // mindmap, quiz, demo, flashcard, search, summary, diagram, timeline
  title          String
  topic          String?
  content        String   @default("{}") // JSON data

  // Context
  maestroId      String?
  conversationId String?
  sessionId      String?

  // User interaction
  userRating     Int?     // 1-5 stars
  isBookmarked   Boolean  @default(false)
  viewCount      Int      @default(0)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([isBookmarked])
}

// ============================================================================
// STUDY SCHEDULER (Smart Notifications & Scheduling - Issue #27)
// ============================================================================

model StudySchedule {
  id          String   @id @default(cuid())
  userId      String   @unique

  // Notification preferences (JSON)
  preferences String   @default("{}") // NotificationPreferences JSON

  sessions    ScheduledSession[]
  reminders   CustomReminder[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model ScheduledSession {
  id            String   @id @default(cuid())
  userId        String
  scheduleId    String
  schedule      StudySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Session details
  dayOfWeek     Int      // 0-6 (Sunday-Saturday)
  time          String   // "16:00" format
  duration      Int      @default(30) // minutes
  subject       String
  maestroId     String?
  topic         String?

  // Scheduling options
  active        Boolean  @default(true)
  reminderOffset Int     @default(5) // minutes before notification
  repeat        String   @default("weekly") // daily | weekly | weekdays | none

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([scheduleId])
  @@index([dayOfWeek])
  @@index([active])
}

model CustomReminder {
  id            String   @id @default(cuid())
  userId        String
  scheduleId    String
  schedule      StudySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Reminder details
  datetime      DateTime
  message       String
  subject       String?
  maestroId     String?

  // Scheduling options
  repeat        String   @default("none") // daily | weekly | none
  active        Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([scheduleId])
  @@index([datetime])
  @@index([active])
}

// ============================================================================
// PWA PUSH NOTIFICATIONS (ADR-0014)
// Push subscription storage for background notifications
// ============================================================================

model PushSubscription {
  id        String    @id @default(cuid())
  userId    String
  endpoint  String    @unique // Push service endpoint URL
  p256dh    String    // Public key for encryption
  auth      String    // Auth secret for encryption
  userAgent String?   // Browser/device info for debugging
  createdAt DateTime  @default(now())
  expiresAt DateTime? // Optional expiration

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================================================
// ACCESSIBILITY SETTINGS (Issue #64 - localStorage consolidation)
// Migrated from: accessibility-store.ts
// ============================================================================

model AccessibilitySettings {
  id        String @id @default(cuid())
  userId    String @unique
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dyslexia support
  dyslexiaFont        Boolean @default(false)
  extraLetterSpacing  Boolean @default(false)
  increasedLineHeight Boolean @default(false)

  // Visual support
  highContrast   Boolean @default(false)
  largeText      Boolean @default(false)
  reducedMotion  Boolean @default(false)

  // Text-to-Speech
  ttsEnabled  Boolean @default(false)
  ttsSpeed    Float   @default(1.0) // 0.5 to 2.0
  ttsAutoRead Boolean @default(false)

  // ADHD support
  adhdMode           Boolean @default(false)
  distractionFreeMode Boolean @default(false)
  breakReminders     Boolean @default(false)

  // General accessibility
  lineSpacing        Float   @default(1.0) // 1.0 to 2.0
  fontSize           Float   @default(1.0) // 0.8 to 1.5
  colorBlindMode     Boolean @default(false)
  keyboardNavigation Boolean @default(true)

  // Custom colors
  customBackgroundColor String @default("#ffffff")
  customTextColor       String @default("#000000")

  // ADHD Session Config (JSON)
  adhdConfig String @default("{}") // ADHDSessionConfig JSON
  adhdStats  String @default("{}") // ADHDSessionStats JSON

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// ONBOARDING STATE (Issue #64 - localStorage consolidation)
// Migrated from: onboarding-store.ts
// ============================================================================

model OnboardingState {
  id        String @id @default(cuid())
  userId    String @unique
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Flow state
  hasCompletedOnboarding Boolean  @default(false)
  onboardingCompletedAt  DateTime?
  currentStep            String   @default("welcome") // OnboardingStep
  isReplayMode           Boolean  @default(false)
  isVoiceMuted           Boolean  @default(false)

  // Collected data (JSON)
  data String @default("{}") // OnboardingData JSON

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// POMODORO STATS (Issue #64 - localStorage consolidation)
// Migrated from: pomodoro-store.ts
// ============================================================================

model PomodoroStats {
  id        String @id @default(cuid())
  userId    String @unique
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Persistent stats
  completedPomodoros Int @default(0)
  totalFocusTime     Int @default(0) // in seconds
  todayPomodoros     Int @default(0)
  todayFocusMinutes  Int @default(0)
  lastActiveDate     String @default("")

  // Settings (JSON)
  settings String @default("{}") // PomodoroSettings JSON

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// CALENDAR EVENTS (Issue #64 - localStorage consolidation)
// Migrated from: calendar-store.ts
// ============================================================================

model CalendarEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  subject     String?
  maestroId   String?

  // Timing
  date        DateTime
  startTime   String?  // "16:00" format
  endTime     String?
  duration    Int?     // in minutes
  allDay      Boolean  @default(false)

  // Recurrence
  recurring   Boolean  @default(false)
  recurrence  String?  // daily | weekly | monthly | none

  // Status
  completed   Boolean  @default(false)
  reminded    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([date])
}

// ============================================================================
// HTML SNIPPETS (Issue #64 - localStorage consolidation)
// Migrated from: app-store.ts HTMLSnippetsStore
// ============================================================================

model HtmlSnippet {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  snippetId String   @unique // Client-generated ID
  html      String
  css       String?
  js        String?
  title     String?
  subject   String?
  maestroId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([snippetId])
}

// ============================================================================
// HOMEWORK SESSIONS (Issue #64 - localStorage consolidation)
// Migrated from: homework-help-view.tsx session storage
// ============================================================================

model HomeworkSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session data
  subject     String?
  topic       String?
  problemType String?
  status      String   @default("active") // active | completed | abandoned

  // Messages and steps (JSON arrays)
  messages String @default("[]")
  steps    String @default("[]")

  // Timing
  startedAt   DateTime @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// ============================================================================
// STUDY KITS (Wave 2 - PDF Upload to Study Materials Generator)
// ============================================================================

model StudyKit {
  id          String   @id @default(cuid())
  userId      String
  sourceFile  String   // PDF filename or path
  title       String

  // Generated materials (JSON strings)
  summary     String?  // Plain text summary
  mindmap     String?  // MindmapData JSON
  demo        String?  // DemoData JSON
  quiz        String?  // QuizData JSON

  // Original PDF content for RAG context
  originalText String? @db.Text  // Full extracted text from PDF

  // Processing status
  status      String   @default("processing") // processing | ready | error
  errorMessage String?

  // Metadata
  subject     String?
  pageCount   Int?
  wordCount   Int?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  learningPaths LearningPath[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// LEARNING PATH (Plan 8 - Progressive Learning Path MVP)
// Progressive learning journey generated from PDF analysis
// ============================================================================

model LearningPath {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  subject     String?

  // Source reference
  sourceStudyKitId String?
  sourceStudyKit   StudyKit? @relation(fields: [sourceStudyKitId], references: [id])

  // Progress tracking
  totalTopics       Int    @default(0)
  completedTopics   Int    @default(0)
  progressPercent   Float  @default(0)
  estimatedMinutes  Int    @default(0)

  // Status: generating | ready | in_progress | completed
  status      String   @default("generating")

  // Visual overview (Mermaid diagram)
  visualOverview String?  // Mermaid diagram code

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  topics      LearningPathTopic[]

  @@index([userId])
  @@index([status])
  @@index([sourceStudyKitId])
  @@index([createdAt])
  @@index([userId, status])
}

model LearningPathTopic {
  id          String   @id @default(cuid())
  pathId      String
  path        LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  order       Int      // Display/progression order
  title       String
  description String
  keyConcepts String   @default("[]") // JSON array of strings
  difficulty  String   @default("intermediate") // basic | intermediate | advanced

  // Status: locked | unlocked | in_progress | completed
  status      String   @default("locked")

  // Time estimates
  estimatedMinutes Int @default(10)

  // Quiz performance
  quizScore   Int?     // Last quiz score (0-100)

  // Related materials from user's library
  relatedMaterials String @default("[]") // JSON: RelatedMaterial[]

  // Timestamps
  startedAt   DateTime?
  completedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  steps       TopicStep[]
  attempts    TopicAttempt[]

  @@index([pathId])
  @@index([order])
  @@index([status])
}

model TopicStep {
  id          String   @id @default(cuid())
  topicId     String
  topic       LearningPathTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  order       Int      // Step order within topic
  type        String   // overview | mindmap | flashcard | quiz
  title       String
  content     String   @default("{}") // JSON content varies by type

  // Completion status
  isCompleted Boolean  @default(false)
  completedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([topicId])
  @@index([order])
  @@index([type])
}

// ============================================================================
// TOPIC ATTEMPT - Track quiz attempts and study sessions per topic
// Plan 8 MVP - Wave 3: Progress Tracking [F-15, F-17]
// ============================================================================

model TopicAttempt {
  id          String   @id @default(cuid())
  topicId     String
  topic       LearningPathTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  userId      String

  // Attempt type: quiz | study | review
  type        String   @default("quiz")

  // Quiz results
  score       Int?     // 0-100
  totalQuestions Int?
  correctAnswers Int?
  passed      Boolean  @default(false)

  // Time tracking
  startedAt   DateTime @default(now())
  completedAt DateTime?
  durationSeconds Int?

  // Answers (JSON array for quiz attempts)
  answers     String?  // JSON: number[] for quiz answers

  createdAt   DateTime @default(now())

  @@index([topicId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// RATE LIMIT EVENTS (Dashboard Analytics - Wave 2)
// ============================================================================

model RateLimitEvent {
  id        String   @id @default(cuid())
  userId    String?
  endpoint  String
  limit     Int
  window    Int      // Window in seconds
  ipAddress String?
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([endpoint, timestamp])
  @@index([timestamp]) // Standalone index for time-range queries
}

// ============================================================================
// SAFETY EVENTS (Dashboard Analytics - Wave 2)
// ============================================================================

model SafetyEvent {
  id              String    @id @default(cuid())
  userId          String?
  type            String    // content_filter | age_verification | harassment | etc.
  severity        String    // low | medium | high | critical
  conversationId  String?
  resolvedBy      String?
  resolvedAt      DateTime?
  resolution      String?
  timestamp       DateTime  @default(now())

  @@index([userId, timestamp])
  @@index([severity, timestamp])
  @@index([timestamp]) // Standalone index for time-range queries
}

// ============================================================================
// GAMIFICATION SYSTEM (MirrorBuddyGamification Plan)
// ============================================================================

model UserGamification {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Points & Level
  totalPoints     Int      @default(0)
  seasonPoints    Int      @default(0)   // Reset each season
  level           Int      @default(1)
  tier            String   @default("principiante") // principiante -> leggenda

  // Season tracking
  currentSeason   String   // e.g., "2026-Q1"
  seasonStartDate DateTime @default(now())

  // MirrorBucks (renamed from XP)
  mirrorBucks     Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  achievements    UserAchievement[]
  streak          DailyStreak?
  pointsHistory   PointsTransaction[]

  @@index([level])
  @@index([totalPoints])
  @@index([currentSeason])
}

model Achievement {
  id          String   @id @default(cuid())
  code        String   @unique  // e.g., "first_session", "streak_7"
  name        String
  description String
  category    String   // COMPLETION, MASTERY, CONSISTENCY, SOCIAL, MILESTONE
  icon        String   // Emoji or icon name
  points      Int      @default(0) // Bonus points when unlocked
  tier        String   @default("bronze") // bronze, silver, gold, platinum
  requirement String   // JSON describing unlock condition
  isSecret    Boolean  @default(false)

  createdAt DateTime @default(now())

  // Relations
  userAchievements UserAchievement[]

  @@index([category])
  @@index([tier])
}

model UserAchievement {
  id             String   @id @default(cuid())
  gamificationId String
  gamification   UserGamification @relation(fields: [gamificationId], references: [id], onDelete: Cascade)
  achievementId  String
  achievement    Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  unlockedAt DateTime @default(now())
  progress   Int      @default(100) // 0-100, 100 = unlocked

  @@unique([gamificationId, achievementId])
  @@index([gamificationId])
  @@index([achievementId])
  @@index([unlockedAt])
}

model DailyStreak {
  id             String   @id @default(cuid())
  gamificationId String   @unique
  gamification   UserGamification @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActivityAt DateTime @default(now())

  // Daily goal tracking
  dailyGoalMinutes Int     @default(30)
  todayMinutes     Int     @default(0)
  goalMetToday     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([currentStreak])
  @@index([lastActivityAt])
}

model PointsTransaction {
  id             String   @id @default(cuid())
  gamificationId String
  gamification   UserGamification @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  points      Int
  reason      String   // "study_session", "flashcard_review", "voice_interaction", "achievement_bonus"
  sourceId    String?  // ID of the triggering entity (session, flashcard, etc.)
  sourceType  String?  // "StudySession", "FlashcardProgress", "Conversation"
  multiplier  Float    @default(1.0) // Streak multiplier applied

  createdAt DateTime @default(now())

  @@index([gamificationId])
  @@index([createdAt])
  @@index([reason])
}

// ============================================================================
// RAG EMBEDDINGS (Plan 9 - Semantic Search for Learning Materials)
// Stores vector embeddings for semantic similarity search.
//
// PostgreSQL Migration (required for vector search):
// 1. Change datasource provider to "postgresql"
// 2. Create pgvector extension: CREATE EXTENSION vector;
// 3. Change 'vector' field type to Unsupported("vector(1536)")
// 4. Add vector index: CREATE INDEX ON "ContentEmbedding" USING ivfflat (vector vector_cosine_ops);
// ============================================================================

model ContentEmbedding {
  id          String   @id @default(cuid())
  userId      String

  // Source content reference
  sourceType  String   // "material" | "flashcard" | "studykit" | "message" | "tool"
  sourceId    String   // ID of the source entity
  chunkIndex  Int      @default(0) // Position within chunked content

  // The actual text that was embedded
  content     String

  // Vector embedding - dual storage for migration
  vector       String?                          // Legacy: JSON array (for backward compat)
  vectorNative Unsupported("vector(1536)")?     // Native pgvector for similarity search

  // Embedding metadata
  model       String   @default("text-embedding-3-small")
  dimensions  Int      @default(1536)
  tokenCount  Int      @default(0)

  // Search optimization
  subject     String?  // Subject area for filtered search
  tags        String   @default("[]") // JSON array of tags

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([sourceType, sourceId, chunkIndex])
  @@index([userId])
  @@index([sourceType])
  @@index([sourceId])
  @@index([subject])
  @@index([createdAt])
}

// ============================================================================
// KNOWLEDGE GRAPH (Wave 3)
// Relationships between materials and concepts
// ============================================================================

// Edges between materials
model MaterialEdge {
  id           String   @id @default(cuid())
  fromId       String
  toId         String
  relationType String   // "derived_from" | "related_to" | "prerequisite" | "extends"
  weight       Float    @default(1.0)
  metadata     Json?
  createdAt    DateTime @default(now())

  from         Material @relation("MaterialEdgeFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to           Material @relation("MaterialEdgeTo", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId, relationType])
  @@index([fromId])
  @@index([toId])
  @@index([relationType])
}

// Abstract concepts for semantic organization
model Concept {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  subject     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  materials   MaterialConcept[]

  @@unique([userId, name])
  @@index([userId])
  @@index([subject])
}

// Junction table: Material <-> Concept
model MaterialConcept {
  materialId String
  conceptId  String
  relevance  Float    @default(1.0)
  createdAt  DateTime @default(now())

  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  concept    Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)

  @@id([materialId, conceptId])
  @@index([materialId])
  @@index([conceptId])
}
