# Technical Debt Check Workflow
# Plan 091 - Debt Prevention System
#
# Runs on PR to main to catch debt before merge

name: Technical Debt Check

on:
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "scripts/**"
      - "*.json"

jobs:
  debt-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for backup files
        run: |
          FOUND=$(find . -type f \( -name "*.bak" -o -name "*.old" -o -name "*.tmp" \) | grep -v node_modules || true)
          if [ -n "$FOUND" ]; then
            echo "::error::Backup files found in repository"
            echo "$FOUND"
            exit 1
          fi
          echo "✓ No backup files found"

      - name: Count TODO/FIXME without issues
        run: |
          COUNT=$(grep -rn --include="*.ts" --include="*.tsx" -E '\b(TODO|FIXME)\b' src/ | grep -v '#[0-9]' | grep -v 'issue' | wc -l || echo "0")
          if [ "$COUNT" -gt 10 ]; then
            echo "::error::Too many TODO/FIXME without issue references: $COUNT (max: 10)"
            grep -rn --include="*.ts" --include="*.tsx" -E '\b(TODO|FIXME)\b' src/ | grep -v '#[0-9]' | grep -v 'issue' | head -15
            exit 1
          fi
          echo "✓ TODO/FIXME without issues: $COUNT"

      - name: Check @deprecated usage growth
        run: |
          COUNT=$(grep -rn '@deprecated' src/ | wc -l)
          if [ "$COUNT" -gt 15 ]; then
            echo "::warning::High @deprecated count: $COUNT. Schedule cleanup."
          fi
          echo "✓ Deprecated functions: $COUNT"

      - name: Check for hardcoded paths
        run: |
          if grep -rn --include="*.ts" --include="*.tsx" '/Users/[a-zA-Z]' src/; then
            echo "::error::Hardcoded personal paths found (/Users/username/)"
            exit 1
          fi
          echo "✓ No hardcoded paths"
