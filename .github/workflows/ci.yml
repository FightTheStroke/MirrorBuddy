name: CI

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

permissions:
  contents: read
  security-events: write

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ISE Engineering Fundamentals: CI/CD
# https://microsoft.github.io/code-with-engineering-playbook/CI-CD/

env:
  NODE_VERSION: "20"

jobs:
  # Lane 1: Build Validation (produces artifacts for other jobs)
  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - run: npm run lint
      - run: npm run typecheck
      - run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      # Share build output with E2E and Performance jobs
      - name: Verify and prepare build output
        run: |
          echo "Build output contents:"
          ls -la .next/ || echo ".next directory not found!"
          du -sh .next/ || echo "Cannot check .next size"
          rm -rf .next/cache
          # Remove files with colons in names (Turbopack externals) - not supported by GitHub artifact upload
          find .next -name "*:*" -delete 2>/dev/null || true
          echo "After cleanup:"
          ls -la .next/ || echo ".next directory missing after cleanup!"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next
          if-no-files-found: error
          include-hidden-files: true
          retention-days: 1

  # Lane 2a: Secret Scanning with TruffleHog (F-09: Entropy-based detection)
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate scanning

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --only-verified

  # Lane 2b: Security Audit + SBOM (runs after secret scanning)
  security:
    name: Security & SBOM
    runs-on: ubuntu-latest
    needs: [secret-scanning]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npm audit --audit-level=high

      - name: Generate SBOM
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

      - name: Legacy Secret Check (Defense-in-Depth)
        run: |
          echo "Running legacy regex-based secret scan (backup to TruffleHog)..."
          FOUND=""

          # OpenAI/Anthropic API keys
          if grep -rE "(sk-[a-zA-Z0-9]{32,}|AKIA[0-9A-Z]{16})" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/; then
            FOUND="$FOUND OpenAI/AWS"
          fi

          # Stripe keys
          if grep -rE "sk_live_[a-zA-Z0-9]{24,}|sk_test_[a-zA-Z0-9]{24,}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/; then
            FOUND="$FOUND Stripe"
          fi

          # Google OAuth secrets
          if grep -rE "GOCSPX-[a-zA-Z0-9_-]{28,}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/; then
            FOUND="$FOUND GoogleOAuth"
          fi

          # Grafana tokens
          if grep -rE "glc_ey[a-zA-Z0-9_=-]{50,}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/; then
            FOUND="$FOUND Grafana"
          fi

          # Resend API keys
          if grep -rE "re_[a-zA-Z0-9]{20,}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/; then
            FOUND="$FOUND Resend"
          fi

          # JWTs (likely hardcoded tokens)
          if grep -rE "eyJhbGciOiJ[a-zA-Z0-9_=-]{100,}" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/; then
            FOUND="$FOUND JWT"
          fi

          if [ -n "$FOUND" ]; then
            echo "BLOCKING: Secrets found! Types:$FOUND"
            exit 1
          fi
          echo "No secrets detected"

      - name: Check for exposed env files
        run: |
          # Check if any .env files are tracked (they shouldn't be)
          if git ls-files | grep -E "^\.env$|^\.env\.local$|^\.env\.production$"; then
            echo "BLOCKING: .env files are tracked in git!"
            exit 1
          fi
          echo "No .env files tracked"

  # Lane 2b: LLM Safety Tests (critical - must always pass)
  llm-safety-tests:
    name: LLM Safety Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      - name: Run jailbreak detector tests
        run: npm run test:unit -- jailbreak-detector --reporter=verbose

      - name: Run content filter tests
        run: npm run test:unit -- content-filter --reporter=verbose

      - name: Run safety tests
        run: npm run test:unit -- safety.test --reporter=verbose

      - name: Verify critical pattern coverage
        run: |
          echo "Verifying LLM safety test coverage..."
          PATTERNS=$(grep -c "pattern:" src/lib/safety/jailbreak-detector/patterns.ts || echo "0")
          TESTS=$(grep -c "it\|test(" src/lib/safety/__tests__/jailbreak-detector.test.ts || echo "0")
          echo "Pattern definitions: $PATTERNS"
          echo "Test cases: $TESTS"
          if [ "$TESTS" -lt 80 ]; then
            echo "WARNING: Less than 80 test cases for jailbreak detection"
          fi
          echo "LLM Safety tests verified successfully"

  # Lane 3: Unit Tests (runs in parallel with build)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      - name: Run unit tests with coverage
        run: npm run test:unit -- --coverage

      - name: Check coverage thresholds
        run: |
          if [ -f coverage/coverage-final.json ]; then
            echo "Coverage report generated - thresholds enforced by Vitest"
          else
            echo "Coverage report not found"
            exit 1
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Lane 4: Documentation Check (fast, runs in parallel)
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check required docs
        run: |
          for f in README.md CONTRIBUTING.md CHANGELOG.md LICENSE .env.example; do
            [ -f "$f" ] && echo "OK: $f" || { echo "MISSING: $f"; exit 1; }
          done

  # Lane 4b: Migration Consistency (fast, runs in parallel)
  migrations:
    name: Migration Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check migration naming convention
        run: |
          echo "Checking migration folder naming..."
          INVALID=$(ls prisma/migrations 2>/dev/null | grep -v "^[0-9]\{14\}_" | grep -v "migration_lock.toml" | grep -v ".DS_Store" || true)
          if [ -n "$INVALID" ]; then
            echo "ERROR: Migration folders must be named YYYYMMDDHHMMSS_name"
            echo "Invalid migrations found:"
            echo "$INVALID"
            exit 1
          fi
          echo "All migrations correctly named"

      - name: Verify migration.sql exists
        run: |
          echo "Checking each migration has migration.sql..."
          for dir in prisma/migrations/[0-9]*/; do
            if [ ! -f "${dir}migration.sql" ]; then
              echo "ERROR: Missing migration.sql in $dir"
              exit 1
            fi
          done
          echo "All migrations have migration.sql files"

  # Lane 5: Code Quality (fast, runs in parallel)
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for forbidden TODOs in critical areas
        run: |
          CRITICAL=$(find src/lib/privacy src/lib/safety src/lib/security \( -name "*.ts" -o -name "*.tsx" \) -exec grep -nE '\bTODO\b|\bFIXME\b' {} + 2>/dev/null || true)
          if [ -n "$CRITICAL" ]; then
            echo "BLOCKING: TODOs found in critical areas:"
            echo "$CRITICAL"
            exit 1
          fi
          echo "No critical TODOs"

      - name: Check console.log (fail on any)
        run: |
          LOGS=$(find src/ \( -name "*.ts" -o -name "*.tsx" \) ! -path "*/__tests__/*" ! -path "*/test/*" ! -name "*.test.ts" ! -name "*.test.tsx" ! -name "setup.ts" -exec grep -n "console\.log" {} + 2>/dev/null | grep -v "logger" | grep -v " \* " | grep -v "//" || true)
          if [ -n "$LOGS" ]; then
            echo "BLOCKING: console.log found (use logger instead):"
            echo "$LOGS"
            exit 1
          fi
          echo "Clean - no console.log"

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Check for circular imports
        run: |
          BASELINE=32
          npx madge --circular --extensions ts,tsx src/ > circular.txt 2>&1 || true
          if grep -q "Found .* circular" circular.txt; then
            COUNT=$(grep -oE "Found ([0-9]+)" circular.txt | grep -oE "[0-9]+")
            echo "Found $COUNT circular dependencies (baseline: $BASELINE)"
            cat circular.txt
            if [ "$COUNT" -gt "$BASELINE" ]; then
              echo "BLOCKING: New circular dependencies introduced! ($COUNT > $BASELINE)"
              exit 1
            else
              echo "WARNING: $COUNT circular dependencies exist (baseline: $BASELINE)"
            fi
          else
            echo "No circular imports detected"
          fi

  # Lane 6a: Mobile E2E Tests - Critical responsive design validation
  # Runs on 3 core devices: iPhone SE (smallest), Pixel 7 (Android), iPad Mini (tablet)
  # Ensures mobile-first design is not broken by new features
  # MANDATORY: Always runs on push and PR (no draft skip)
  mobile-e2e:
    name: Mobile E2E Tests
    runs-on: ubuntu-latest
    needs: [build]

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run Mobile E2E tests
        run: |
          echo "Running mobile E2E tests on 3 core devices..."
          npx playwright test --project=iphone-se --project=pixel-7 --project=ipad-mini
        env:
          CI: true
          CI_MOBILE_TESTS: "1"
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-e2e-report
          path: playwright-report/
          retention-days: 30

  # Lane 6b: E2E Tests - Full end-to-end test suite
  # MANDATORY: Always runs on push and PR (no draft skip)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run E2E tests
        run: npm run test
        env:
          CI: true
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # Lane 7: Docker Build Test (runs in parallel)
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: mirrorbuddy:test

  # Lane 8: Performance Budgets
  # MANDATORY: Always runs on push and PR (no draft skip)
  performance:
    name: Performance Budgets
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Check bundle sizes
        run: |
          # Check for large chunks (>500KB is warning, >1.2MB is error)
          # Note: markmap-lib bundles prismjs + highlight.js (~1.1MB) for mindmap code highlighting
          LARGE_CHUNKS=$(find .next/static/chunks -name "*.js" -size +1200k 2>/dev/null | head -5)
          if [ -n "$LARGE_CHUNKS" ]; then
            echo "ERROR: Chunks over 1.2MB found:"
            for chunk in $LARGE_CHUNKS; do
              du -h "$chunk"
            done
            exit 1
          fi

          WARN_CHUNKS=$(find .next/static/chunks -name "*.js" -size +500k 2>/dev/null | head -5)
          if [ -n "$WARN_CHUNKS" ]; then
            echo "WARNING: Chunks over 500KB found:"
            for chunk in $WARN_CHUNKS; do
              du -h "$chunk"
            done
          fi

          TOTAL=$(du -sh .next/static/chunks 2>/dev/null | cut -f1)
          echo "Total chunks size: $TOTAL"

      - name: Generate bundle report
        run: |
          mkdir -p bundle-report
          echo "# Bundle Analysis Report" > bundle-report/report.md
          echo "" >> bundle-report/report.md
          echo "Generated: $(date -u)" >> bundle-report/report.md
          echo "" >> bundle-report/report.md
          echo "## Chunk Sizes" >> bundle-report/report.md
          echo '```' >> bundle-report/report.md
          find .next/static/chunks -name "*.js" -exec du -h {} \; | sort -rh | head -20 >> bundle-report/report.md
          echo '```' >> bundle-report/report.md
          echo "" >> bundle-report/report.md
          echo "## Total Size" >> bundle-report/report.md
          du -sh .next/static/chunks >> bundle-report/report.md

      - name: Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-report
          path: bundle-report/
          retention-days: 30

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.14.x
          lhci autorun || echo "Lighthouse completed with warnings"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30
