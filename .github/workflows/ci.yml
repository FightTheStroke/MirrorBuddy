name: CI

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

permissions:
  contents: read
  security-events: write

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ISE Engineering Fundamentals: CI/CD
# https://microsoft.github.io/code-with-engineering-playbook/CI-CD/

env:
  NODE_VERSION: "20"

jobs:
  # =========================================================================
  # CHANGE DETECTION - Determines which areas are affected by this PR/push
  # Used to skip expensive jobs when changes don't affect their area.
  # On push to main, all downstream jobs run unconditionally.
  # See: docs/ci/affected-ci.md
  # =========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.filter.outputs.src }}
      ui: ${{ steps.filter.outputs.ui }}
      mobile: ${{ steps.filter.outputs.mobile }}
      prisma: ${{ steps.filter.outputs.prisma }}
      i18n: ${{ steps.filter.outputs.i18n }}
      safety: ${{ steps.filter.outputs.safety }}
      config: ${{ steps.filter.outputs.config }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
              - 'public/**'
            ui:
              - 'src/app/**'
              - 'src/components/**'
              - 'src/styles/**'
              - 'public/**'
              - 'messages/**'
            mobile:
              - 'ios/**'
              - 'android/**'
              - 'capacitor.config.ts'
              - 'src/lib/native/**'
              - 'src/components/mobile/**'
            prisma:
              - 'prisma/**'
            i18n:
              - 'messages/**'
              - 'src/i18n/**'
              - 'src/lib/i18n/**'
            safety:
              - 'src/lib/safety/**'
              - 'src/lib/ai/**'
              - 'src/lib/privacy/**'
              - 'src/data/maestri/**'
            config:
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - 'eslint.config.mjs'
              - 'eslint-local-rules/**'
              - 'next.config.ts'
              - 'vitest.config.ts'
              - 'playwright.config*.ts'
              - '.github/**'
            docs:
              - 'docs/**'
              - '*.md'
      - name: Log detected changes
        run: |
          echo "Affected areas:"
          echo "  src=${{ steps.filter.outputs.src }}"
          echo "  ui=${{ steps.filter.outputs.ui }}"
          echo "  mobile=${{ steps.filter.outputs.mobile }}"
          echo "  prisma=${{ steps.filter.outputs.prisma }}"
          echo "  i18n=${{ steps.filter.outputs.i18n }}"
          echo "  safety=${{ steps.filter.outputs.safety }}"
          echo "  config=${{ steps.filter.outputs.config }}"
          echo "  docs=${{ steps.filter.outputs.docs }}"

  # Lane 1: Build Validation (produces artifacts for other jobs)
  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - run: npm run lint
      - run: npm run typecheck
      - run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          # Required for provider check during build - ensures correct page rendering
          OLLAMA_URL: http://localhost:11434

      # Share build output with E2E and Performance jobs
      - name: Verify and prepare build output
        run: |
          echo "Build output contents:"
          ls -la .next/ || echo ".next directory not found!"
          du -sh .next/ || echo "Cannot check .next size"
          rm -rf .next/cache
          # Remove files with colons in names (Turbopack externals) - not supported by GitHub artifact upload
          find .next -name "*:*" -delete 2>/dev/null || true
          # Copy static assets into standalone directory (required by Next.js standalone server)
          # See: https://nextjs.org/docs/app/api-reference/config/next-config-js/output#automatically-copying-traced-files
          cp -r .next/static .next/standalone/.next/static
          cp -r public .next/standalone/public
          echo "After cleanup:"
          ls -la .next/ || echo ".next directory missing after cleanup!"
          echo "Standalone static assets:"
          ls -la .next/standalone/.next/static/ || echo "static copy failed!"
          ls -la .next/standalone/public/ | head -5 || echo "public copy failed!"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next
          if-no-files-found: error
          include-hidden-files: true
          retention-days: 1

  # Lane 2a: Secret Scanning with TruffleHog (F-09: Entropy-based detection)
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate scanning

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --only-verified

  # Lane 2a-bis: Technical Debt Check
  # Conditional: skipped on PR when only docs/ci changed (no src or config)
  debt-check:
    name: Technical Debt Audit
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >
      github.event_name != 'pull_request' ||
      needs.detect-changes.outputs.src == 'true' ||
      needs.detect-changes.outputs.config == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run debt check
        run: npm run debt:check

  # Lane 2b: SBOM & Env Safety
  # npm audit: covered by dependency-review.yml (PR) + weekly-security-audit.yml
  # Legacy secret regex: covered by TruffleHog (Lane 2a)
  security:
    name: SBOM & Env Safety
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Generate SBOM
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

      - name: Check for exposed env files
        run: |
          # Check if any .env files are tracked (they shouldn't be)
          if git ls-files | grep -E "^\.env$|^\.env\.local$|^\.env\.production$"; then
            echo "BLOCKING: .env files are tracked in git!"
            exit 1
          fi
          echo "No .env files tracked"

  # Lane 2b: LLM Safety Tests (critical - must always pass)
  llm-safety-tests:
    name: LLM Safety Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      - name: Run jailbreak detector tests
        run: npm run test:unit -- jailbreak-detector --reporter=verbose

      - name: Run content filter tests
        run: npm run test:unit -- content-filter --reporter=verbose

      - name: Run safety tests
        run: npm run test:unit -- safety.test --reporter=verbose

      - name: Verify critical pattern coverage
        run: |
          echo "Verifying LLM safety test coverage..."
          PATTERNS=$(grep -c "pattern:" src/lib/safety/jailbreak-detector/patterns.ts || echo "0")
          TESTS=$(grep -c "it\|test(" src/lib/safety/__tests__/jailbreak-detector.test.ts || echo "0")
          echo "Pattern definitions: $PATTERNS"
          echo "Test cases: $TESTS"
          if [ "$TESTS" -lt 80 ]; then
            echo "WARNING: Less than 80 test cases for jailbreak detection"
          fi
          echo "LLM Safety tests verified successfully"

  # Lane 3: Unit Tests (runs in parallel with build)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      - name: Run unit tests with coverage
        run: npm run test:unit -- --coverage

      - name: Check coverage thresholds
        run: |
          if [ -f coverage/coverage-final.json ]; then
            echo "Coverage report generated - thresholds enforced by Vitest"
          else
            echo "Coverage report not found"
            exit 1
          fi

      - name: Regression Gate - Skipped test monitoring (BLOCKING)
        run: |
          echo "Monitoring skipped tests to prevent regression debt..."
          BASELINE=3  # Reduced baseline after fixing skipped tests

          # Count describe.skip/it.skip/test.skip in source (more reliable than coverage grep)
          SKIPPED=$(grep -rE '\b(describe|it|test)\.skip\b' src/ --include='*.test.ts' --include='*.test.tsx' | wc -l | tr -d ' ')

          echo "Skipped unit tests found: $SKIPPED (baseline: $BASELINE)"

          if [ "$SKIPPED" -gt "$BASELINE" ]; then
            echo "::error::BLOCKING: Skipped tests ($SKIPPED) above baseline ($BASELINE)"
            echo "Fix or remove skipped tests before merging."
            exit 1
          fi
          echo "Skip gate passed: $SKIPPED <= $BASELINE"

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Lane 4: Documentation Check (fast, runs in parallel)
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check required docs
        run: |
          for f in README.md CONTRIBUTING.md CHANGELOG.md LICENSE .env.example; do
            [ -f "$f" ] && echo "OK: $f" || { echo "MISSING: $f"; exit 1; }
          done

  # Lane 4b: Migration Consistency
  # Conditional: skipped on PR when no prisma/ files changed
  migrations:
    name: Migration Check
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >
      github.event_name != 'pull_request' ||
      needs.detect-changes.outputs.prisma == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check migration naming convention
        run: |
          echo "Checking migration folder naming..."
          INVALID=$(ls prisma/migrations 2>/dev/null | grep -v "^[0-9]\{14\}_" | grep -v "migration_lock.toml" | grep -v ".DS_Store" || true)
          if [ -n "$INVALID" ]; then
            echo "ERROR: Migration folders must be named YYYYMMDDHHMMSS_name"
            echo "Invalid migrations found:"
            echo "$INVALID"
            exit 1
          fi
          echo "All migrations correctly named"

      - name: Verify migration.sql exists
        run: |
          echo "Checking each migration has migration.sql..."
          for dir in prisma/migrations/[0-9]*/; do
            if [ ! -f "${dir}migration.sql" ]; then
              echo "ERROR: Missing migration.sql in $dir"
              exit 1
            fi
          done
          echo "All migrations have migration.sql files"

  # Lane 5: Code Quality (fast, runs in parallel)
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for forbidden TODOs in critical areas
        run: |
          CRITICAL=$(find src/lib/privacy src/lib/safety src/lib/security \( -name "*.ts" -o -name "*.tsx" \) -exec grep -nE '\bTODO\b|\bFIXME\b' {} + 2>/dev/null || true)
          if [ -n "$CRITICAL" ]; then
            echo "BLOCKING: TODOs found in critical areas:"
            echo "$CRITICAL"
            exit 1
          fi
          echo "No critical TODOs"

      - name: Check console.log (fail on any)
        run: |
          LOGS=$(find src/ \( -name "*.ts" -o -name "*.tsx" \) ! -path "*/__tests__/*" ! -path "*/test/*" ! -name "*.test.ts" ! -name "*.test.tsx" ! -name "setup.ts" -exec grep -n "console\.log" {} + 2>/dev/null | grep -v "logger" | grep -v " \* " | grep -v "//" || true)
          if [ -n "$LOGS" ]; then
            echo "BLOCKING: console.log found (use logger instead):"
            echo "$LOGS"
            exit 1
          fi
          echo "Clean - no console.log"

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Check for circular imports
        run: |
          BASELINE=32
          npx madge --circular --extensions ts,tsx src/ > circular.txt 2>&1 || true
          if grep -q "Found .* circular" circular.txt; then
            COUNT=$(grep -oE "Found ([0-9]+)" circular.txt | grep -oE "[0-9]+")
            echo "Found $COUNT circular dependencies (baseline: $BASELINE)"
            cat circular.txt
            if [ "$COUNT" -gt "$BASELINE" ]; then
              echo "BLOCKING: New circular dependencies introduced! ($COUNT > $BASELINE)"
              exit 1
            else
              echo "WARNING: $COUNT circular dependencies exist (baseline: $BASELINE)"
            fi
          else
            echo "No circular imports detected"
          fi

      - name: Check module boundary violations
        run: |
          BASELINE=465
          COUNT=$(npx eslint --no-cache --rule 'local-rules/enforce-module-boundaries: [warn, {protectedModules: [safety, privacy, ai, education, rag, accessibility, tier, auth, security, compliance]}]' src/ 2>&1 | grep -c "enforce-module-boundaries" || echo "0")
          echo "Module boundary violations: $COUNT (baseline: $BASELINE)"
          if [ "$COUNT" -gt "$BASELINE" ]; then
            echo "BLOCKING: New module boundary violations! ($COUNT > $BASELINE)"
            echo "Use barrel exports (@/lib/module) instead of deep imports."
            exit 1
          fi
          echo "Boundary gate passed: $COUNT <= $BASELINE"

  # Lane 5c: Sentry Production Configuration (runs on push only, uses Vercel CLI)
  sentry-config:
    name: Sentry Config (Vercel)
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Validate VERCEL_TOKEN is set
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::error::VERCEL_TOKEN is not configured in GitHub secrets"
            echo ""
            echo "This token is required to access Vercel API for deployment and Sentry configuration."
            echo ""
            echo "To fix:"
            echo "1. Regenerate personal access token: https://vercel.com/account/tokens"
            echo "2. Update GitHub secret: https://github.com/FightTheStroke/MirrorBuddy/settings/secrets/actions"
            echo "3. Set VERCEL_TOKEN to the new token value"
            exit 1
          fi
          echo "✅ VERCEL_TOKEN is configured"

      - name: Verify Sentry configuration against Vercel production env
        run: bash ./scripts/verify-sentry-config.sh
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Pre-deploy validation (DSN, tokens, env vars)
        run: npx tsx scripts/validate-pre-deploy.ts
        env:
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}

  # Lane 5b: SMOKE TESTS - Critical Path Validation (BLOCKING)
  # Runs on EVERY PR - fast, high-value tests that catch regressions
  # Must pass before any merge to main
  smoke-tests:
    name: Smoke Tests (BLOCKING)
    runs-on: ubuntu-latest
    needs: [build]

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run Smoke Tests
        run: |
          echo "Running critical path smoke tests..."
          npm run test:e2e:smoke -- --reporter=list
        env:
          CI: true
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          # Must match playwright.config.ts webServer.env and global-setup.ts E2E_SESSION_SECRET
          SESSION_SECRET: e2e-test-session-secret-32-characters-min
          # Bypass provider check redirect to /landing (no Azure keys in CI)
          OLLAMA_URL: http://localhost:11434

      - name: Upload smoke test report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: test-results/
          retention-days: 7

  # Lane 5.5: Accessibility Tests - WCAG 2.1 AA compliance
  # BLOCKING: Gates deployment AND PR merge - ensures WCAG 2.1 AA compliance
  # Smart mode: full E2E suite when UI changes, unit test baseline otherwise
  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build, detect-changes]

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run Accessibility Tests (smart)
        run: |
          if [ "${{ needs.detect-changes.outputs.ui }}" = "true" ] || [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "Running FULL a11y E2E suite (UI changes detected or push event)"
            npx playwright test --project=a11y --reporter=list
          else
            echo "Running a11y unit test baseline (no UI changes)"
            npm run test:unit -- accessibility --reporter=verbose
          fi
        env:
          CI: true
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          SESSION_SECRET: e2e-test-session-secret-32-characters-min
          # Bypass provider check redirect to /landing (no Azure keys in CI)
          OLLAMA_URL: http://localhost:11434

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-test-report
          path: test-results/
          retention-days: 7

  # Lane 6a: Mobile Smoke - Fast PR feedback
  # Runs the smallest supported viewport to catch obvious mobile regressions early.
  # Conditional: skipped when no UI or mobile files changed
  mobile-smoke:
    name: Mobile Smoke (PR)
    runs-on: ubuntu-latest
    needs: [build, detect-changes]
    if: >
      github.event_name == 'pull_request' &&
      (needs.detect-changes.outputs.ui == 'true' || needs.detect-changes.outputs.mobile == 'true')

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run Mobile Smoke tests
        run: |
          echo "Running mobile smoke tests (iPhone SE)..."
          npx playwright test --project=iphone-se --reporter=list
        env:
          CI: true
          CI_MOBILE_TESTS: "1"
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          # Must match playwright.config.ts webServer.env and global-setup.ts E2E_SESSION_SECRET
          SESSION_SECRET: e2e-test-session-secret-32-characters-min
          # Bypass provider check redirect to /landing (no Azure keys in CI)
          OLLAMA_URL: http://localhost:11434

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-smoke-report
          path: test-results/
          retention-days: 7

  # Lane 6a-bis: Mobile Build Pipeline - Capacitor build validation (PR only, informational)
  # Validates that the mobile build pipeline (Next.js export + Capacitor copy) works correctly
  # Non-blocking: provides early feedback but does not gate PR merges
  # Conditional: skipped when no mobile or src files changed
  mobile-build:
    name: Mobile Build Validation
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: >
      github.event_name == 'pull_request' &&
      (needs.detect-changes.outputs.mobile == 'true' || needs.detect-changes.outputs.src == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      - name: Build mobile web assets
        run: npm run build:mobile:web
        env:
          NEXT_TELEMETRY_DISABLED: 1
          # Required for provider check during build
          OLLAMA_URL: http://localhost:11434

      - name: Copy web assets to native
        run: npx cap copy

      - name: Verify mobile build output
        run: |
          echo "Verifying mobile build output directories..."

          # Check Next.js export output
          if [ -d "out" ]; then
            echo "✓ Next.js export directory exists: out/"
            du -sh out/
          else
            echo "ERROR: out/ directory not found"
            exit 1
          fi

          # Check Capacitor directories
          if [ -d "ios/App/public" ]; then
            echo "✓ iOS web assets copied: ios/App/public/"
            du -sh ios/App/public/
          else
            echo "WARNING: ios/App/public/ not found (iOS platform may not be configured)"
          fi

          if [ -d "android/app/src/main/assets/public" ]; then
            echo "✓ Android web assets copied: android/app/src/main/assets/public/"
            du -sh android/app/src/main/assets/public/
          else
            echo "WARNING: android/app/src/main/assets/public/ not found (Android platform may not be configured)"
          fi

          echo "Mobile build validation completed successfully"

  # Lane 6a: Mobile E2E Tests - Critical responsive design validation
  # Runs on 3 core devices: iPhone SE (smallest), Pixel 7 (Android), iPad Mini (tablet)
  # Ensures mobile-first design is not broken by new features
  # Runs on push (full mobile matrix). PRs use mobile-smoke for fast feedback.
  mobile-e2e:
    name: Mobile E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name != 'pull_request'

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run Mobile E2E tests
        run: |
          echo "Running mobile E2E tests on 3 core devices..."
          npx playwright test --project=iphone-se --project=pixel-7 --project=ipad-mini --reporter=list
        env:
          CI: true
          CI_MOBILE_TESTS: "1"
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          # Must match playwright.config.ts webServer.env and global-setup.ts E2E_SESSION_SECRET
          SESSION_SECRET: e2e-test-session-secret-32-characters-min
          # Bypass provider check redirect to /landing (no Azure keys in CI)
          OLLAMA_URL: http://localhost:11434

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-e2e-report
          path: test-results/
          retention-days: 30

      - name: Mobile E2E failure check
        if: failure()
        run: |
          echo "::error::Mobile E2E Tests Failed - This is a BLOCKING check"
          echo ""
          echo "Mobile responsive design regression detected!"
          echo ""
          echo "What to check:"
          echo "1. Touch targets: All interactive elements must be ≥44×44px (WCAG 2.5.5)"
          echo "2. Responsive layout: Use mobile-first classes (grid-cols-1 md:grid-cols-2)"
          echo "3. Horizontal scroll: Ensure no overflow on small screens"
          echo "4. Text readability: Font sizes appropriate for mobile devices"
          echo ""
          echo "Device viewports tested:"
          echo "- iPhone SE: 375×667px (smallest supported)"
          echo "- Pixel 7: 412×915px (Android flagship)"
          echo "- iPad Mini: 768×1024px (tablet portrait)"
          echo ""
          echo "See mobile-e2e-report artifact for detailed test results."
          exit 1

  # Lane 6b: E2E Tests - Full end-to-end test suite
  # BLOCKING: Gates deployment - ensures critical user flows work end-to-end
  # Includes retry logic (2 retries) to handle transient CI issues
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build]
    if: github.event_name != 'pull_request'

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run E2E tests (with retries)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_on: error
          command: npx playwright test --project=chromium --reporter=list
        env:
          CI: true
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          # Must match playwright.config.ts webServer.env and global-setup.ts E2E_SESSION_SECRET
          SESSION_SECRET: e2e-test-session-secret-32-characters-min
          # Bypass provider check redirect to /landing (no Azure keys in CI)
          OLLAMA_URL: http://localhost:11434

      - name: Upload test screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-failures
          path: test-results/
          retention-days: 7

  # Lane 6c: Security E2E Tests - CSRF, cookie signing, authorization
  # BLOCKING: Ensures security controls are not regressed
  security-e2e:
    name: Security E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    if: github.event_name != 'pull_request'

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run Security E2E tests
        run: npm run test:e2e:security -- --reporter=list
        env:
          CI: true
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          SESSION_SECRET: e2e-test-session-secret-32-characters-min
          OLLAMA_URL: http://localhost:11434

      - name: Upload security test report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-e2e-report
          path: test-results/
          retention-days: 7

  # Lane 6d: Compliance E2E Tests - AI Act, GDPR, COPPA, data privacy
  # BLOCKING: Ensures regulatory compliance controls are not regressed
  compliance-e2e:
    name: Compliance E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    if: github.event_name != 'pull_request'

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: mirrorbuddy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run Compliance E2E tests
        run: npm run test:e2e:compliance -- --reporter=list
        env:
          CI: true
          TEST_DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DATABASE_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          DIRECT_URL: postgresql://postgres:${{ secrets.TEST_DB_PASSWORD }}@localhost:5432/mirrorbuddy_test
          SESSION_SECRET: e2e-test-session-secret-32-characters-min
          OLLAMA_URL: http://localhost:11434

      - name: Upload compliance test report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-e2e-report
          path: test-results/
          retention-days: 7

  # Lane 7: Docker Build Test (runs in parallel)
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: mirrorbuddy:test

  # Lane 8: Performance Budgets
  # Runs on push. PRs skip this lane to prioritize fast feedback.
  performance:
    name: Performance Budgets (BLOCKING)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - run: npx prisma generate

      # Download pre-built .next from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next

      - name: Check bundle sizes
        run: |
          # Check for large chunks (>500KB is warning, >1.2MB is error)
          # Note: markmap-lib bundles prismjs + highlight.js (~1.1MB) for mindmap code highlighting
          LARGE_CHUNKS=$(find .next/static/chunks -name "*.js" -size +1200k 2>/dev/null | head -5)
          if [ -n "$LARGE_CHUNKS" ]; then
            echo "ERROR: Chunks over 1.2MB found:"
            for chunk in $LARGE_CHUNKS; do
              du -h "$chunk"
            done
            exit 1
          fi

          WARN_CHUNKS=$(find .next/static/chunks -name "*.js" -size +500k 2>/dev/null | head -5)
          if [ -n "$WARN_CHUNKS" ]; then
            echo "WARNING: Chunks over 500KB found:"
            for chunk in $WARN_CHUNKS; do
              du -h "$chunk"
            done
          fi

          TOTAL=$(du -sh .next/static/chunks 2>/dev/null | cut -f1)
          echo "Total chunks size: $TOTAL"

      - name: Generate bundle report
        run: |
          mkdir -p bundle-report
          echo "# Bundle Analysis Report" > bundle-report/report.md
          echo "" >> bundle-report/report.md
          echo "Generated: $(date -u)" >> bundle-report/report.md
          echo "" >> bundle-report/report.md
          echo "## Chunk Sizes" >> bundle-report/report.md
          echo '```' >> bundle-report/report.md
          find .next/static/chunks -name "*.js" -exec du -h {} \; | sort -rh | head -20 >> bundle-report/report.md
          echo '```' >> bundle-report/report.md
          echo "" >> bundle-report/report.md
          echo "## Total Size" >> bundle-report/report.md
          du -sh .next/static/chunks >> bundle-report/report.md

      - name: Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-report
          path: bundle-report/
          retention-days: 30

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.14.x
          lhci autorun || echo "Lighthouse completed with warnings"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30

  # ==========================================================================
  # PR GATE - Single status check for PRs (fast feedback)
  # Required jobs must succeed. Conditional jobs may be skipped (not failed).
  # accessibility-tests is ALWAYS required (WCAG 2.1 AA blocking).
  # ==========================================================================
  pr-gate:
    name: "PR Gate"
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - build
      - secret-scanning
      - debt-check
      - security
      - llm-safety-tests
      - unit-tests
      - docs
      - migrations
      - quality
      - smoke-tests
      - accessibility-tests
      - mobile-smoke
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Check all PR jobs passed
        if: |
          needs.detect-changes.result != 'success' ||
          needs.build.result != 'success' ||
          needs.secret-scanning.result != 'success' ||
          needs.security.result != 'success' ||
          needs.llm-safety-tests.result != 'success' ||
          needs.unit-tests.result != 'success' ||
          needs.docs.result != 'success' ||
          needs.quality.result != 'success' ||
          needs.smoke-tests.result != 'success' ||
          needs.accessibility-tests.result != 'success' ||
          (needs.debt-check.result != 'success' && needs.debt-check.result != 'skipped') ||
          (needs.migrations.result != 'success' && needs.migrations.result != 'skipped') ||
          (needs.mobile-smoke.result != 'success' && needs.mobile-smoke.result != 'skipped')
        run: |
          echo "::error::PR BLOCKED - One or more checks failed"
          echo ""
          echo "Required jobs:"
          echo "  detect-changes: ${{ needs.detect-changes.result }}"
          echo "  build: ${{ needs.build.result }}"
          echo "  secret-scanning: ${{ needs.secret-scanning.result }}"
          echo "  security: ${{ needs.security.result }}"
          echo "  llm-safety-tests: ${{ needs.llm-safety-tests.result }}"
          echo "  unit-tests: ${{ needs.unit-tests.result }}"
          echo "  docs: ${{ needs.docs.result }}"
          echo "  quality: ${{ needs.quality.result }}"
          echo "  smoke-tests: ${{ needs.smoke-tests.result }}"
          echo "  accessibility-tests: ${{ needs.accessibility-tests.result }}"
          echo ""
          echo "Conditional jobs (skipped is OK):"
          echo "  debt-check: ${{ needs.debt-check.result }}"
          echo "  migrations: ${{ needs.migrations.result }}"
          echo "  mobile-smoke: ${{ needs.mobile-smoke.result }}"
          exit 1

      - name: PR approved
        if: |
          needs.detect-changes.result == 'success' &&
          needs.build.result == 'success' &&
          needs.secret-scanning.result == 'success' &&
          needs.security.result == 'success' &&
          needs.llm-safety-tests.result == 'success' &&
          needs.unit-tests.result == 'success' &&
          needs.docs.result == 'success' &&
          needs.quality.result == 'success' &&
          needs.smoke-tests.result == 'success' &&
          needs.accessibility-tests.result == 'success' &&
          (needs.debt-check.result == 'success' || needs.debt-check.result == 'skipped') &&
          (needs.migrations.result == 'success' || needs.migrations.result == 'skipped') &&
          (needs.mobile-smoke.result == 'success' || needs.mobile-smoke.result == 'skipped')
        run: |
          echo "PR gate passed - Safe to merge"

  # ==========================================================================
  # DEPLOYMENT GATE - Single status check for Vercel
  # This job MUST pass before Vercel deploys to production
  # Configure in Vercel: Settings → Git → "Wait for Deployment Checks"
  # ==========================================================================
  deployment-gate:
    name: "✅ Deployment Gate"
    runs-on: ubuntu-latest
    needs:
      - build
      - secret-scanning
      - debt-check
      - security
      - llm-safety-tests
      - unit-tests
      - docs
      - migrations
      - quality
      - smoke-tests
      - accessibility-tests
      - e2e-tests
      - security-e2e
      - compliance-e2e
      - mobile-e2e
      - docker
      - performance
      - sentry-config
    if: always() && github.event_name != 'pull_request'
    steps:
      - name: Check all jobs passed
        if: |
          needs.build.result != 'success' ||
          needs.secret-scanning.result != 'success' ||
          needs.debt-check.result != 'success' ||
          needs.security.result != 'success' ||
          needs.llm-safety-tests.result != 'success' ||
          needs.unit-tests.result != 'success' ||
          needs.docs.result != 'success' ||
          needs.migrations.result != 'success' ||
          needs.quality.result != 'success' ||
          needs.smoke-tests.result != 'success' ||
          needs.accessibility-tests.result != 'success' ||
          needs.e2e-tests.result != 'success' ||
          needs.security-e2e.result != 'success' ||
          needs.compliance-e2e.result != 'success' ||
          needs.mobile-e2e.result != 'success' ||
          needs.docker.result != 'success' ||
          needs.performance.result != 'success'
        run: |
          echo "::error::DEPLOYMENT BLOCKED - One or more checks failed"
          echo ""
          echo "Job results:"
          echo "  build: ${{ needs.build.result }}"
          echo "  secret-scanning: ${{ needs.secret-scanning.result }}"
          echo "  debt-check: ${{ needs.debt-check.result }}"
          echo "  security: ${{ needs.security.result }}"
          echo "  llm-safety-tests: ${{ needs.llm-safety-tests.result }}"
          echo "  unit-tests: ${{ needs.unit-tests.result }}"
          echo "  docs: ${{ needs.docs.result }}"
          echo "  migrations: ${{ needs.migrations.result }}"
          echo "  quality: ${{ needs.quality.result }}"
          echo "  smoke-tests: ${{ needs.smoke-tests.result }}"
          echo "  accessibility-tests: ${{ needs.accessibility-tests.result }}"
          echo "  e2e-tests: ${{ needs.e2e-tests.result }}"
          echo "  security-e2e: ${{ needs.security-e2e.result }}"
          echo "  compliance-e2e: ${{ needs.compliance-e2e.result }}"
          echo "  mobile-e2e: ${{ needs.mobile-e2e.result }}"
          echo "  docker: ${{ needs.docker.result }}"
          echo "  performance: ${{ needs.performance.result }}"
          exit 1

      - name: Deployment approved
        if: |
          needs.build.result == 'success' &&
          needs.secret-scanning.result == 'success' &&
          needs.debt-check.result == 'success' &&
          needs.security.result == 'success' &&
          needs.llm-safety-tests.result == 'success' &&
          needs.unit-tests.result == 'success' &&
          needs.docs.result == 'success' &&
          needs.migrations.result == 'success' &&
          needs.quality.result == 'success' &&
          needs.smoke-tests.result == 'success' &&
          needs.accessibility-tests.result == 'success' &&
          needs.e2e-tests.result == 'success' &&
          needs.security-e2e.result == 'success' &&
          needs.compliance-e2e.result == 'success' &&
          needs.mobile-e2e.result == 'success' &&
          needs.docker.result == 'success' &&
          needs.performance.result == 'success'
        run: |
          echo "All blocking checks passed - Safe to deploy to production"
          echo ""
          echo "Verified jobs (all blocking):"
          echo "  build"
          echo "  secret-scanning"
          echo "  debt-check"
          echo "  security"
          echo "  llm-safety-tests"
          echo "  unit-tests"
          echo "  docs"
          echo "  migrations"
          echo "  quality"
          echo "  smoke-tests"
          echo "  accessibility-tests"
          echo "  e2e-tests"
          echo "  security-e2e"
          echo "  compliance-e2e"
          echo "  mobile-e2e"
          echo "  docker"
          echo "  performance"
          echo ""
          echo "Triggering Vercel deployment via CLI..."

  # ============================================================================
  # DEPLOY TO VERCEL (via CLI)
  # ============================================================================
  # Deploys to Vercel ONLY after ALL checks pass.
  # Auto-deploy is disabled via ignoreCommand in vercel.json.
  # This saves build minutes by not building until CI passes.
  # ============================================================================
  deploy-to-vercel:
    name: "🚀 Deploy to Vercel"
    runs-on: ubuntu-latest
    needs: [deployment-gate]
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.deployment-gate.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate VERCEL_TOKEN is set
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::error::VERCEL_TOKEN is not configured in GitHub secrets"
            echo ""
            echo "This token is required to deploy to production."
            echo ""
            echo "To fix:"
            echo "1. Regenerate personal access token: https://vercel.com/account/tokens"
            echo "   - Go to https://vercel.com/account/tokens"
            echo "   - Create a new token with scope: full"
            echo "   - Copy the token value"
            echo "2. Update GitHub secret: https://github.com/FightTheStroke/MirrorBuddy/settings/secrets/actions"
            echo "   - Click 'New repository secret'"
            echo "   - Name: VERCEL_TOKEN"
            echo "   - Value: (paste the token from step 1)"
            echo "   - Click 'Add secret'"
            echo "3. The next push to main will use the new token"
            exit 1
          fi
          echo "✅ VERCEL_TOKEN is configured (length: ${{ secrets.VERCEL_TOKEN && 'present' || 'missing' }})"

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Production
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "✅ Deployed to: $url"
          echo "DEPLOYMENT_URL=$url" >> $GITHUB_ENV

      - name: Verify Deployment Health
        run: |
          echo "Waiting 10s for deployment to stabilize..."
          sleep 10
          status=$(curl -s -o /dev/null -w "%{http_code}" https://mirrorbuddy.vercel.app/api/health)
          if [ "$status" = "200" ]; then
            echo "✅ Health check passed (HTTP $status)"
          else
            echo "⚠️ Health check returned HTTP $status (may still be warming up)"
          fi
